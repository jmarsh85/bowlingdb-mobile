<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BowlingDB">
<title>BowlingDB Pro</title>
<style>
/* ============================================================
   DESIGN TOKENS
   ============================================================ */
:root {
  --bg0: #0E0314;
  --bg1: #160920;
  --bg2: #1E0E28;
  --bg3: #261630;
  --bg4: #301E3A;
  --teal:   #00D9D9;
  --cyan:   #00FFFF;
  --purple: #9D4EDD;
  --sedona: #E85D4C;
  --gold:   #FFD700;
  --green:  #00DD66;
  --white:  #FFFFFF;
  --t1: #FFFFFF;
  --t2: #B0A8C0;
  --t3: #706880;
  --border1: #2A1A35;
  --border2: #3D2850;
  --pin-base:    #1A0A22;
  --pin-stand:   #FFFFFF;
  --pin-knock:   #00D9D9;
  --pin-border-base:  #2E1A3E;
  --pin-border-stand: #888888;
  --pin-border-knock: #00A0A0;
  --glow-teal:   0 0 18px rgba(0,217,217,0.45);
  --glow-purple: 0 0 18px rgba(157,78,221,0.45);
  --glow-gold:   0 0 14px rgba(255,215,0,0.4);
  --safe-t: env(safe-area-inset-top, 44px);
  --safe-b: env(safe-area-inset-bottom, 20px);
  --transition: 0.22s cubic-bezier(0.4,0,0.2,1);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html { height:100%; overflow:hidden; }
body {
  height:100%;
  background:var(--bg0);
  color:var(--t1);
  font-family:-apple-system,'SF Pro Display',BlinkMacSystemFont,'Helvetica Neue',sans-serif;
  -webkit-font-smoothing:antialiased;
  overflow:hidden;
  user-select:none;
  -webkit-user-select:none;
}

/* ============================================================
   APP SHELL
   ============================================================ */
#app {
  display:flex;
  flex-direction:column;
  height:100%;
  max-width:430px;
  margin:0 auto;
  position:relative;
  overflow:hidden;
}

/* ============================================================
   HEADER
   ============================================================ */
#hdr {
  flex-shrink:0;
  display:flex;
  align-items:center;
  gap:10px;
  padding:calc(var(--safe-t) + 6px) 16px 10px;
  background:var(--bg1);
  border-bottom:1px solid var(--border1);
  z-index:20;
  min-height:calc(var(--safe-t) + 50px);
}
#hdr-back {
  width:34px; height:34px;
  display:flex; align-items:center; justify-content:center;
  color:var(--teal); 
  cursor:pointer; flex-shrink:0;
  opacity:0; pointer-events:none;
  transition:opacity 0.2s;
  border-radius:50%;
}
#hdr-back.show { opacity:1; pointer-events:auto; }
#hdr-title { flex:1; font-size:17px; font-weight:700; letter-spacing:0.2px; }
#hdr-title .brand { color:var(--teal); }
#hdr-right { display:flex; align-items:center; gap:8px; flex-shrink:0; }
.hdr-icon-btn {
  width:34px; height:34px;
  border-radius:50%;
  background:var(--bg3);
  border:1px solid var(--border2);
  color:var(--t2);
  font-size:16px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  transition:all 0.15s;
}
.hdr-icon-btn:active { transform:scale(0.88); background:var(--bg4); }

/* ============================================================
   SCREEN STACK  
   ============================================================ */
#screens {
  flex:1;
  position:relative;
  overflow:hidden;
}
.screen {
  position:absolute;
  inset:0;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  padding:14px 14px calc(var(--safe-b) + 10px);
  visibility:hidden;
  pointer-events:none;
  transform:translateX(100%);
  transition:transform var(--transition), opacity var(--transition);
  opacity:0;
}
.screen.active {
  visibility:visible;
  pointer-events:auto;
  transform:translateX(0);
  opacity:1;
}
.screen.prev {
  transform:translateX(-30%);
  opacity:0;
  visibility:hidden;
  pointer-events:none;
}

/* ============================================================
   BOTTOM NAV
   ============================================================ */
#bnav {
  flex-shrink:0;
  display:flex;
  background:var(--bg1);
  border-top:1px solid var(--border1);
  padding-bottom:var(--safe-b);
}
.bnav-item {
  flex:1;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:8px 4px 5px;
  cursor:pointer;
  gap:3px;
  transition:opacity 0.15s;
}
.bnav-item:active { opacity:0.6; }
.bnav-icon-wrap {
  width:26px; height:26px;
  display:flex; align-items:center; justify-content:center;
  transition:filter 0.2s, transform 0.2s;
}
.bnav-icon { font-size:22px; transition:filter 0.2s, transform 0.2s; }
.bnav-label { font-size:9px; color:var(--t3); font-weight:600; letter-spacing:0.5px; text-transform:uppercase; transition:color 0.2s; }
.bnav-item.on .bnav-icon-wrap { filter:drop-shadow(0 0 5px rgba(0,217,217,0.8)); transform:translateY(-1px); }
.bnav-item.on .bnav-icon { filter:drop-shadow(0 0 5px var(--teal)); }
.bnav-item.on .bnav-label { color:var(--teal); }

/* ============================================================
   SHARED COMPONENTS
   ============================================================ */
.sec-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:14px;
}
.sec-title { font-size:22px; font-weight:800; letter-spacing:-0.5px; }

/* Buttons */
.btn {
  display:flex; align-items:center; justify-content:center;
  width:100%; padding:14px 20px;
  border-radius:14px; border:none;
  font-size:15px; font-weight:700;
  cursor:pointer;
  transition:transform 0.12s, opacity 0.12s;
  gap:6px;
}
.btn:active { transform:scale(0.97); opacity:0.85; }
.btn + .btn { margin-top:8px; }
.btn-primary {
  background:linear-gradient(135deg, #00B8B8, var(--teal));
  color:#000;
  box-shadow:var(--glow-teal);
}
.btn-secondary {
  background:var(--bg3);
  color:var(--t1);
  border:1px solid var(--border2);
}
.btn-ghost {
  background:transparent;
  color:var(--teal);
  border:1.5px solid rgba(0,217,217,0.35);
}
.btn-danger {
  background:rgba(232,93,76,0.15);
  color:var(--sedona);
  border:1px solid rgba(232,93,76,0.4);
}
.btn-gold {
  background:linear-gradient(135deg, #B8900A, var(--gold));
  color:#000;
  box-shadow:var(--glow-gold);
}
.btn-sm {
  width:auto; padding:8px 16px;
  font-size:13px; border-radius:10px;
}

/* Add button */
.add-btn {
  width:36px; height:36px;
  border-radius:50%;
  background:linear-gradient(135deg, var(--teal), var(--purple));
  border:none; color:#000;
  font-size:22px; font-weight:300;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  box-shadow:var(--glow-teal);
  transition:transform 0.15s;
  flex-shrink:0;
}
.add-btn:active { transform:scale(0.85); }

/* Cards */
.card {
  background:var(--bg2);
  border-radius:16px;
  border:1px solid var(--border1);
  padding:14px;
  margin-bottom:10px;
}
.card-tap {
  cursor:pointer;
  transition:transform 0.12s, background 0.12s;
}
.card-tap:active { transform:scale(0.985); background:var(--bg3); }

/* Form elements */
.fgroup { margin-bottom:14px; }
.flabel {
  display:block;
  font-size:10px; font-weight:700; letter-spacing:1px;
  text-transform:uppercase; color:var(--t3);
  margin-bottom:7px;
}
.finput {
  width:100%;
  background:var(--bg3); border:1.5px solid var(--border2);
  border-radius:12px; padding:13px 14px;
  color:var(--t1); font-size:16px;
  outline:none; -webkit-appearance:none;
  transition:border-color 0.15s;
}
.finput:focus { border-color:var(--teal); }
/* Kill scroll-wheel spin on ALL number inputs — prevents accidental value changes */
input[type="number"] { -moz-appearance:textfield; }
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
select.finput {
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2300D9D9' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 14px center;
  padding-right:38px;
}

.divider { height:1px; background:var(--border1); margin:14px 0; }
.pill {
  display:inline-flex; align-items:center;
  padding:3px 10px; border-radius:20px;
  font-size:11px; font-weight:700; letter-spacing:0.4px;
}
.pill-teal { background:rgba(0,217,217,0.12); color:var(--teal); border:1px solid rgba(0,217,217,0.3); }
.pill-gold { background:rgba(255,215,0,0.12); color:var(--gold); border:1px solid rgba(255,215,0,0.3); }
.pill-sedona { background:rgba(232,93,76,0.12); color:var(--sedona); border:1px solid rgba(232,93,76,0.3); }

.empty-state {
  text-align:center; padding:50px 20px 30px;
  color:var(--t3);
}
.empty-icon { font-size:52px; margin-bottom:14px; opacity:0.7; }
.empty-label { font-size:16px; font-weight:700; color:var(--t2); margin-bottom:6px; }
.empty-sub { font-size:13px; }

/* List items */
.list-row {
  display:flex; align-items:center;
  background:var(--bg2); border-radius:14px;
  border:1px solid var(--border1);
  padding:13px 14px;
  margin-bottom:9px;
  cursor:pointer;
  transition:transform 0.12s, background 0.12s;
  gap:12px;
}
.list-row:active { transform:scale(0.985); background:var(--bg3); }
.list-row-body { flex:1; min-width:0; }
.list-row-name { font-size:16px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.list-row-meta { font-size:12px; color:var(--t3); margin-top:2px; }
.list-row-chevron { color:var(--t3); font-size:20px; flex-shrink:0; }
.list-row-dashed { border-style:dashed; border-color:var(--border2); }

/* ============================================================
   HOME SCREEN
   ============================================================ */
.home-hero { text-align:center; padding:18px 0 22px; }
.home-logo {
  font-size:38px; font-weight:900; letter-spacing:-2px;
  background:linear-gradient(135deg, var(--cyan) 0%, var(--teal) 50%, var(--purple) 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text;
}
.home-sub { font-size:10px; color:var(--t3); letter-spacing:3px; text-transform:uppercase; margin-top:4px; }

.qs-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:14px; }
.qs-card {
  background:var(--bg2); border-radius:14px;
  border:1px solid var(--border1);
  padding:12px 8px; text-align:center;
}
.qs-val { font-size:24px; font-weight:800; color:var(--teal); }
.qs-lbl { font-size:10px; color:var(--t3); margin-top:3px; font-weight:600; letter-spacing:0.5px; }

.nav-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:14px; }
.nav-tile {
  background:var(--bg2); border-radius:16px;
  border:1px solid var(--border1);
  padding:16px 8px 14px;
  display:flex; flex-direction:column; align-items:center; gap:10px;
  cursor:pointer; transition:transform 0.12s, background 0.12s;
}
.nav-tile:active { transform:scale(0.96); background:var(--bg3); }
.nav-tile-icon-wrap {
  width:50px; height:50px; border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  border:1px solid rgba(255,255,255,0.07);
}
.nav-tile-icon { font-size:26px; }
.nav-tile-txt { font-size:11px; font-weight:700; color:var(--t2); letter-spacing:0.3px; text-align:center; line-height:1.2; }

.bsk-legend {
  display:flex; gap:16px; justify-content:center;
  padding:12px 16px;
  background:var(--bg2); border-radius:14px;
  border:1px solid var(--border1);
}
.leg-item { display:flex; align-items:center; gap:7px; font-size:12px; color:var(--t2); font-weight:500; }
.leg-dot { width:11px; height:11px; border-radius:50%; }
.leg-dot.base { background:var(--pin-base); border:1.5px solid var(--pin-border-base); }
.leg-dot.stand { background:var(--pin-stand); }
.leg-dot.knock { background:var(--pin-knock); box-shadow:0 0 6px var(--teal); }

/* ============================================================
   SCORECARD
   ============================================================ */
.sc-wrap {
  background:var(--bg2); border-radius:16px;
  border:1px solid var(--border1);
  overflow:hidden; margin-bottom:12px;
}
.sc-scroll { overflow-x:auto; -webkit-overflow-scrolling:touch; }
.sc-grid {
  display:grid;
  grid-template-columns:repeat(9,38px) 76px;
  gap:1px;
  background:var(--border1);
  min-width:fit-content;
  padding:1px;
}
.sc-frame {
  background:var(--bg1);
  display:flex; flex-direction:column;
  transition:background 0.2s;
}
.sc-frame.cur { background:rgba(0,217,217,0.06); }

.sc-fn {
  text-align:center; padding:4px 2px;
  font-size:9px; font-weight:800; color:var(--t3);
  border-bottom:1px solid var(--border1);
  letter-spacing:0.5px;
}
.sc-frame.cur .sc-fn { color:var(--teal); }

/* Mini BSK triangle */
.sc-bsk {
  display:flex; flex-direction:column; align-items:center;
  padding:5px 2px; gap:1.5px;
  min-height:40px;
}
.sc-bsk.f10 { flex-direction:row; justify-content:space-evenly; align-items:center; padding:3px 2px; gap:1px; min-height:40px; }
.bsk-tri { display:flex; flex-direction:column; align-items:center; gap:1.5px; }
.bsk-tri.tiny { transform:scale(0.78); transform-origin:center; }
.bsk-row-m { display:flex; gap:1.5px; }

/* ── BSK dot colorways ──────────────────────────────────────────
   B  =  already down before this attempt
          dark fill + purple ring (faded — out of play)
   S  =  standing after this attempt
          teal/cyan solid fill — bright, "still alive"
   K  =  knocked THIS attempt
          teal fill + purple outer ring — the action event
   ────────────────────────────────────────────────────────────── */
.dot {
  width:5.5px; height:5.5px; border-radius:50%;
  /* Default = B state */
  background:var(--bg0);
  border:1.5px solid rgba(157,78,221,0.5);
  box-sizing:border-box;
  transition:background 0.15s, box-shadow 0.15s, border-color 0.15s;
}
.dot.B {
  background:var(--bg0);
  border:1.5px solid rgba(157,78,221,0.45);
  opacity:0.55;
}
.dot.S {
  background:var(--teal);
  border:1.5px solid var(--teal);
  box-shadow:0 0 3px rgba(0,217,217,0.5);
  opacity:1;
}
.dot.K {
  background:var(--teal);
  border:1.5px solid var(--purple);
  box-shadow:0 0 0 1px var(--purple), 0 0 5px rgba(157,78,221,0.4);
  opacity:1;
}

/* Attempt boxes */
.sc-atts {
  display:flex; justify-content:center; align-items:center;
  gap:2px; padding:4px 2px;
  border-top:1px solid var(--border1);
  min-height:24px;
}
.att {
  width:17px; height:17px;
  border-radius:3px;
  background:var(--bg2);
  display:flex; align-items:center; justify-content:center;
  font-size:11px; font-weight:800;
}
.att.X { color:var(--gold); }
.att.sp { color:var(--teal); }
.att.op { color:var(--sedona); }
.att.nt { color:var(--gold); font-size:9px; opacity:0.85; } /* NoTap 9-pin "strike" */
.att.split { color:var(--sedona); border:1.5px solid var(--sedona); border-radius:50%; width:19px; height:19px; }
.att.cur { background:rgba(0,217,217,0.18); color:var(--teal); font-size:8px; }

/* Running total */
.sc-tot {
  text-align:center; padding:4px 2px;
  font-size:13px; font-weight:800; color:var(--t1);
  border-top:1px solid var(--border1);
  background:var(--bg0);
  min-height:22px;
}
.sc-tot.pend { color:rgba(0,217,217,0.4); font-size:9px; letter-spacing:0.5px; }

/* ============================================================
   SCORING SCREEN LAYOUT
   ============================================================ */
.sc-ctx {
  display:flex; align-items:center; justify-content:space-between;
  background:var(--bg2); border-radius:14px;
  border:1px solid var(--border1);
  padding:10px 14px; margin-bottom:10px;
}
.ctx-block { text-align:center; }
.ctx-lbl { font-size:9px; font-weight:700; color:var(--t3); letter-spacing:1px; text-transform:uppercase; }
.ctx-val { font-size:22px; font-weight:800; color:var(--teal); line-height:1.1; }
.ctx-sub { font-size:10px; color:var(--t3); margin-top:2px; }

/* Pinfall readout */
.pf-display {
  text-align:center; padding:8px 14px;
  background:var(--bg2); border-radius:14px;
  border:1px solid var(--border1);
  margin-bottom:10px;
}
.pf-big { font-size:48px; font-weight:900; color:var(--teal); line-height:1; }
.pf-lbl { font-size:10px; color:var(--t3); letter-spacing:1px; text-transform:uppercase; margin-top:2px; }

/* ============================================================
   PIN BUTTONS
   ============================================================ */
.pin-stage {
  display:flex; flex-direction:column; align-items:center;
  gap:12px; padding:14px 0 10px;
}
.pin-row { display:flex; gap:14px; justify-content:center; }

.pin-btn {
  width:62px; height:62px;
  border-radius:50%; border:2.5px solid var(--pin-border-base);
  background:var(--pin-base); color:#3A2A4A;
  font-size:18px; font-weight:800;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  transition:all 0.12s;
  position:relative;
  box-shadow:inset 0 3px 8px rgba(0,0,0,0.5);
}

/* STANDING — white/bright */
.pin-btn.S {
  border-color:var(--pin-border-stand);
  background:rgba(255,255,255,0.08);
  color:var(--t1);
  box-shadow:inset 0 2px 6px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.07);
}

/* KNOCKED — teal glow (spare mode: pin you hit) */
.pin-btn.K {
  border-color:var(--pin-border-knock);
  background:rgba(0,217,217,0.15);
  color:var(--teal);
  box-shadow:0 0 18px rgba(0,217,217,0.35), inset 0 2px 6px rgba(0,0,0,0.2);
}

/* LEAVE — pin marked as STANDING on attempt 1 (amber/gold highlight) */
.pin-btn.L {
  border-color:#CC9900;
  background:rgba(255,215,0,0.14);
  color:var(--gold);
  box-shadow:0 0 18px rgba(255,215,0,0.3), inset 0 2px 6px rgba(0,0,0,0.2);
}

/* BASE — already down, greyed out */
.pin-btn.B {
  border-color:#1A0A22;
  background:var(--bg0);
  color:#2A1A35;
  cursor:default;
  box-shadow:none;
  opacity:0.35;
}

.pin-btn:not(.B):active { transform:scale(0.84); }

/* ============================================================
   MODE BADGE — FRESH / LEAVE / SPARE
   ============================================================ */
.mode-badge {
  display:inline-flex; align-items:center; justify-content:center;
  padding:3px 10px; border-radius:20px;
  font-size:10px; font-weight:800; letter-spacing:1px;
  text-transform:uppercase; margin-top:4px;
  transition:all 0.2s;
}
.mode-badge.FRESH {
  background:rgba(0,217,217,0.12);
  color:var(--teal);
  border:1px solid rgba(0,217,217,0.3);
}
.mode-badge.LEAVE {
  background:rgba(255,215,0,0.12);
  color:var(--gold);
  border:1px solid rgba(255,215,0,0.35);
}
.mode-badge.SPARE {
  background:rgba(157,78,221,0.12);
  color:var(--purple);
  border:1px solid rgba(157,78,221,0.3);
}

/* Mode instruction banner — shown below context bar */
.mode-instruction {
  text-align:center;
  font-size:12px; font-weight:600;
  padding:8px 14px;
  border-radius:12px; margin-bottom:10px;
  transition:all 0.25s;
}
.mode-instruction.FRESH {
  background:rgba(0,217,217,0.07);
  color:var(--teal);
  border:1px solid rgba(0,217,217,0.2);
}
.mode-instruction.LEAVE {
  background:rgba(255,215,0,0.07);
  color:var(--gold);
  border:1px solid rgba(255,215,0,0.2);
}
.mode-instruction.SPARE {
  background:rgba(157,78,221,0.07);
  color:var(--purple);
  border:1px solid rgba(157,78,221,0.2);
}

/* Pinfall display adapts to mode */
.pf-big.leave-mode { color:var(--gold); }
.pf-big.spare-mode { color:var(--purple); }
.qa-row { display:flex; gap:8px; margin-bottom:9px; }
.qa-btn {
  flex:1; padding:13px 8px;
  border-radius:13px; border:none;
  font-size:14px; font-weight:800;
  cursor:pointer;
  transition:all 0.12s;
}
.qa-btn:active { transform:scale(0.95); opacity:0.8; }
.qa-strike { background:linear-gradient(135deg,#AA7800,var(--gold)); color:#000; }
.qa-spare  { background:linear-gradient(135deg,#008080,var(--teal)); color:#000; }
.qa-miss   { background:var(--bg3); color:var(--sedona); border:1.5px solid rgba(232,93,76,0.4); }

/* UNDO BAR */
.undo-bar {
  display:flex; align-items:center; justify-content:space-between;
  background:rgba(157,78,221,0.12);
  border:1px solid rgba(157,78,221,0.3);
  border-radius:12px; padding:10px 14px;
  margin-bottom:9px;
  opacity:0; pointer-events:none;
  transform:translateY(-8px);
  transition:all 0.3s;
}
.undo-bar.show { opacity:1; pointer-events:auto; transform:translateY(0); }
.undo-txt { font-size:13px; color:var(--t2); }
.undo-btn {
  padding:6px 14px; border-radius:8px;
  background:var(--purple); color:#FFF;
  font-size:13px; font-weight:700;
  border:none; cursor:pointer;
  transition:transform 0.12s;
}
.undo-btn:active { transform:scale(0.92); }
.undo-countdown {
  width:20px; height:20px;
  border-radius:50%;
  border:2px solid var(--purple);
  display:flex; align-items:center; justify-content:center;
  font-size:10px; font-weight:700; color:var(--purple);
}

/* Ball bar */
.ball-bar {
  display:flex; align-items:center; justify-content:space-between;
  background:var(--bg2); border:1px solid var(--border1);
  border-radius:12px; padding:9px 14px;
  margin-bottom:9px;
}
.ball-info { display:flex; align-items:center; gap:10px; font-size:13px; color:var(--t2); }
.ball-icon {
  width:30px; height:30px; border-radius:50%;
  background:radial-gradient(circle at 35% 35%, var(--purple), #280060);
  border:2px solid rgba(157,78,221,0.5);
  box-shadow:0 0 8px rgba(157,78,221,0.3);
}
.ball-change { font-size:12px; color:var(--teal); font-weight:600; cursor:pointer; }

/* ============================================================
   SERIES / LEAGUE LIST
   ============================================================ */
.series-card {
  background:var(--bg2); border-radius:16px;
  border:1px solid var(--border1);
  padding:14px; margin-bottom:10px;
  cursor:pointer;
  transition:transform 0.12s, background 0.12s;
}
.series-card:active { transform:scale(0.985); background:var(--bg3); }
.series-hdr { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px; }
.series-date { font-size:15px; font-weight:800; }
.series-total { font-size:26px; font-weight:900; color:var(--teal); }
.series-games { display:flex; gap:8px; }
.game-badge {
  flex:1; text-align:center; padding:8px 4px;
  background:var(--bg1); border-radius:10px;
  font-size:18px; font-weight:800;
  border:1px solid var(--border1);
}
.game-badge.done { color:var(--teal); }
.game-badge.inprog { color:var(--gold); font-size:11px; padding-top:11px; }
.game-badge.empty { color:var(--t3); font-size:20px; }

/* ============================================================
   GAME COMPLETE SCREEN
   ============================================================ */
.gc-hero {
  text-align:center; padding:20px 0 18px;
}
.gc-score { font-size:80px; font-weight:900; line-height:1;
  background:linear-gradient(135deg,var(--cyan),var(--teal));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text;
}
.gc-lbl { font-size:12px; color:var(--t3); letter-spacing:1.5px; text-transform:uppercase; margin-top:4px; }
.gc-diff { font-size:16px; font-weight:700; margin-top:8px; }
.gc-diff.pos { color:var(--green); }
.gc-diff.neg { color:var(--sedona); }
.gc-diff.neu { color:var(--t3); }

.stat-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 0; border-bottom:1px solid var(--border1);
  font-size:14px;
}
.stat-row:last-child { border-bottom:none; }
.sval { font-weight:800; }
.sval.t { color:var(--teal); }
.sval.g { color:var(--gold); }
.sval.s { color:var(--sedona); }

/* ============================================================
   STATS SCREEN
   ============================================================ */
.stat-card { background:var(--bg2); border-radius:16px; border:1px solid var(--border1); padding:16px; margin-bottom:10px; }
.stat-card-title { font-size:10px; font-weight:700; color:var(--t3); letter-spacing:1px; text-transform:uppercase; margin-bottom:6px; }
.stat-card-val { font-size:40px; font-weight:900; line-height:1; }
.stat-card-sub { font-size:12px; color:var(--t3); margin-top:6px; }
.prog-bar { height:5px; background:var(--bg1); border-radius:3px; margin-top:12px; overflow:hidden; }
.prog-fill { height:100%; background:linear-gradient(90deg,var(--teal),var(--cyan)); border-radius:3px; transition:width 0.8s ease; }

/* ============================================================
   MODAL SHEET
   ============================================================ */
.modal-bg {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.75);
  z-index:100;
  display:flex; align-items:flex-end;
  opacity:0; pointer-events:none;
  transition:opacity 0.25s;
}
.modal-bg.open { opacity:1; pointer-events:auto; }
.modal-sheet {
  width:100%; max-height:88vh;
  background:var(--bg2);
  border-radius:22px 22px 0 0;
  border-top:1px solid var(--border2);
  padding:16px 16px calc(var(--safe-b) + 16px);
  overflow-y:auto;
  transform:translateY(100%);
  transition:transform 0.28s cubic-bezier(0.32,0.72,0,1);
}
.modal-bg.open .modal-sheet { transform:translateY(0); }
.modal-handle { width:40px; height:4px; background:var(--border2); border-radius:2px; margin:0 auto 18px; }
.modal-title { font-size:20px; font-weight:800; margin-bottom:16px; }

/* ============================================================
   TOAST & HAPTIC FEEDBACK
   ============================================================ */
.toast {
  position:fixed; z-index:200;
  top:calc(var(--safe-t) + 56px);
  left:50%; transform:translateX(-50%) translateY(-80px);
  background:var(--bg4); border:1px solid var(--border2);
  border-radius:22px; padding:9px 20px;
  font-size:13px; font-weight:700;
  white-space:nowrap;
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
.toast.show { transform:translateX(-50%) translateY(0); }

/* ============================================================
   ATTEMPT NAVIGATION BAR  (prev / frame-att indicator / next)
   ============================================================ */
.att-nav {
  display:flex; align-items:center; gap:6px;
  background:var(--bg2); border-radius:14px;
  border:1px solid var(--border1);
  padding:8px 10px; margin-bottom:9px;
}
.att-nav-btn {
  width:38px; height:38px; border-radius:11px;
  background:var(--bg3); border:1.5px solid var(--border2);
  color:var(--teal); 
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; flex-shrink:0;
  transition:all 0.13s;
}
.att-nav-btn:active { transform:scale(0.88); background:var(--bg4); }
.att-nav-btn:disabled, .att-nav-btn.disabled {
  color:var(--t3); border-color:var(--border1);
  opacity:0.35; pointer-events:none;
}
.att-nav-center { flex:1; text-align:center; }
.att-nav-label {
  font-size:11px; font-weight:700; color:var(--t3);
  letter-spacing:1px; text-transform:uppercase;
}
.att-nav-val {
  font-size:17px; font-weight:800; color:var(--t1); line-height:1.2;
}
.att-nav-mode {
  font-size:10px; font-weight:700; letter-spacing:0.5px;
  margin-top:2px;
}

/* Scorecard frames are tappable to navigate */
.sc-frame { cursor:pointer; transition:background 0.15s; }
.sc-frame:active { background:rgba(0,217,217,0.1) !important; }
.sc-frame.cur { background:rgba(0,217,217,0.06); }
.sc-frame.tapped-highlight {
  animation: frameTap 0.3s ease;
}
@keyframes frameTap {
  0% { background:rgba(0,217,217,0.25); }
  100% { background:rgba(0,217,217,0.06); }
}

/* Pinfall display — compact */
.pf-display {
  display:flex; align-items:center; justify-content:space-between;
  text-align:left; padding:10px 16px;
  background:var(--bg2); border-radius:14px;
  border:1px solid var(--border1);
  margin-bottom:9px;
}
.pf-big { font-size:42px; font-weight:900; color:var(--teal); line-height:1; }
.pf-lbl { font-size:11px; color:var(--t3); letter-spacing:0.5px; text-transform:uppercase; margin-top:2px; }
.pf-right { text-align:right; }

/* Mode badge inline in nav */
.att-nav-modepill {
  display:inline-flex; align-items:center; justify-content:center;
  padding:2px 9px; border-radius:20px;
  font-size:9px; font-weight:800; letter-spacing:1px;
  text-transform:uppercase;
  transition:all 0.2s;
}
.att-nav-modepill.LEAVE {
  background:rgba(255,215,0,0.12); color:var(--gold);
  border:1px solid rgba(255,215,0,0.35);
}
.att-nav-modepill.SPARE {
  background:rgba(157,78,221,0.12); color:var(--purple);
  border:1px solid rgba(157,78,221,0.3);
}
.att-nav-modepill.FRESH {
  background:rgba(0,217,217,0.12); color:var(--teal);
  border:1px solid rgba(0,217,217,0.3);
}
.notes-icon-btn {
  width:34px; height:34px;
  border-radius:50%;
  background:var(--bg3);
  border:1.5px solid var(--border2);
  color:var(--t3);
  font-size:17px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  transition:all 0.15s;
  flex-shrink:0;
}
.notes-icon-btn:active { transform:scale(0.88); }
.notes-icon-btn.has-note {
  color:var(--gold);
  border-color:rgba(255,215,0,0.5);
  background:rgba(255,215,0,0.08);
  box-shadow: 0 0 8px rgba(255,215,0,0.2);
}
.notes-modal-textarea {
  width:100%;
  background:var(--bg3);
  border:1.5px solid var(--border2);
  border-radius:12px;
  padding:13px 14px;
  color:var(--t1);
  font-size:15px;
  line-height:1.5;
  resize:none;
  outline:none;
  min-height:120px;
  font-family:inherit;
}
.notes-modal-textarea:focus { border-color:var(--gold); }
.notes-context {
  font-size:11px; color:var(--t3); margin-bottom:12px;
  font-weight:600; letter-spacing:0.5px;
}

/* ============================================================
   NOTAP / TOGGLE STYLES
   ============================================================ */
.toggle-row {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 0;
}
.toggle-label { font-size:14px; font-weight:600; }
.toggle-sub { font-size:11px; color:var(--t3); margin-top:2px; }
.toggle-switch {
  width:50px; height:28px;
  background:var(--bg4);
  border-radius:14px;
  border:1.5px solid var(--border2);
  position:relative;
  cursor:pointer;
  transition:all 0.2s;
  flex-shrink:0;
}
.toggle-switch.on {
  background:rgba(0,217,217,0.2);
  border-color:var(--teal);
}
.toggle-switch::after {
  content:'';
  position:absolute;
  top:3px; left:3px;
  width:19px; height:19px;
  border-radius:50%;
  background:var(--t3);
  transition:all 0.2s;
}
.toggle-switch.on::after {
  left:24px;
  background:var(--teal);
  box-shadow:0 0 6px var(--teal);
}

/* NoTap scorecard toggle */
.sc-display-toggle {
  display:flex; align-items:center; gap:8px;
  margin-bottom:10px;
}
.sc-dt-btn {
  flex:1; padding:7px 10px;
  border-radius:10px;
  background:var(--bg3);
  border:1.5px solid var(--border2);
  color:var(--t2);
  font-size:12px; font-weight:700;
  cursor:pointer;
  text-align:center;
  transition:all 0.15s;
}
.sc-dt-btn.on {
  background:rgba(0,217,217,0.12);
  border-color:var(--teal);
  color:var(--teal);
}
.sc-dt-btn:active { transform:scale(0.97); }
.notap-badge {
  display:inline-flex; align-items:center;
  padding:2px 8px; border-radius:8px;
  font-size:10px; font-weight:700;
  background:rgba(255,215,0,0.15);
  color:var(--gold);
  border:1px solid rgba(255,215,0,0.3);
  margin-left:6px;
}

/* Lane pair selector */
.lane-pair-row {
  display:flex; gap:8px; align-items:stretch;
}
.lane-num-input {
  flex:1;
  background:var(--bg3); border:1.5px solid var(--border2);
  border-radius:12px; padding:13px 14px;
  color:var(--t1); font-size:16px;
  outline:none; -webkit-appearance:none;
  text-align:center; font-weight:700;
}
.lane-num-input:focus { border-color:var(--teal); }
.lane-sep {
  display:flex; align-items:center; font-size:14px;
  color:var(--t3); font-weight:700; padding:0 2px;
}
.odd-even-toggle {
  display:flex; border-radius:12px; overflow:hidden;
  border:1.5px solid var(--border2);
  margin-top:8px;
}
.oe-btn {
  flex:1; padding:11px 8px;
  background:var(--bg3);
  color:var(--t2); font-size:13px; font-weight:700;
  cursor:pointer; text-align:center;
  transition:all 0.15s;
  border:none;
}
.oe-btn.on {
  background:rgba(0,217,217,0.15);
  color:var(--teal);
}
.lane-preview {
  font-size:12px; color:var(--t3); margin-top:8px; text-align:center;
}

/* ── Archive toggle on league list ─────────────────────────── */
.show-archived-row {
  display:flex; align-items:center; justify-content:flex-end;
  padding:0 4px 8px; gap:8px;
  font-size:12px; color:var(--t3); font-weight:600;
}
.show-archived-row .toggle-switch { transform:scale(0.85); }
.league-archived { opacity:0.45; }
.archived-badge {
  font-size:9px; font-weight:800; color:var(--t3);
  background:var(--bg3); border:1px solid var(--border2);
  border-radius:6px; padding:1px 5px; margin-left:6px;
  letter-spacing:0.5px; text-transform:uppercase;
}

/* ── Series card with edit button ───────────────────────────── */
.series-card-wrap { position:relative; }
.series-card-actions {
  display:flex; gap:8px; padding:0 0 6px;
  justify-content:flex-end;
}
.sc-act-btn {
  padding:5px 12px; border-radius:10px; font-size:11px; font-weight:700;
  cursor:pointer; border:1px solid var(--border1);
  background:var(--bg2); color:var(--t2);
  transition:all 0.12s;
}
.sc-act-btn.edit { color:var(--teal); border-color:rgba(0,217,217,0.3); }
.sc-act-btn.stats-btn { color:var(--purple); border-color:rgba(157,78,221,0.3); }
.sc-act-btn:active { transform:scale(0.95); }

/* ── Game row with edit action ──────────────────────────────── */
.game-row-wrap { position:relative; }
.game-row-actions {
  display:flex; gap:6px; padding:4px 0 8px; justify-content:flex-end;
}
.gr-act-btn {
  padding:4px 10px; border-radius:8px; font-size:11px; font-weight:700;
  cursor:pointer; border:1px solid var(--border1);
  background:var(--bg2); color:var(--t2); transition:all 0.12s;
}
.gr-act-btn.edit { color:var(--teal); border-color:rgba(0,217,217,0.3); }
.gr-act-btn:active { transform:scale(0.95); }

/* ── Settings modal sections ─────────────────────────────────── */
.settings-section {
  background:var(--bg3); border-radius:12px; padding:12px 14px;
  margin-bottom:12px; border:1px solid var(--border1);
}
.settings-section-hdr {
  font-size:11px; font-weight:800; color:var(--t3);
  text-transform:uppercase; letter-spacing:0.8px;
  margin-bottom:10px; display:flex; flex-direction:column; gap:2px;
}
.settings-section-hint {
  font-size:10px; font-weight:500; color:var(--t3);
  text-transform:none; letter-spacing:0; opacity:0.7;
}
.id-seed-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:6px 12px;
}
.id-seed-row {
  display:flex; align-items:center; gap:8px;
}
.id-seed-lbl {
  font-size:11px; font-weight:700; color:var(--t2);
  min-width:52px;
}
.id-seed-input {
  flex:1; background:var(--bg2); border:1.5px solid var(--border2);
  border-radius:8px; padding:5px 8px;
  color:var(--t1); font-size:13px; font-weight:700;
  outline:none; -webkit-appearance:none;
  text-align:right;
}
.id-seed-input:focus { border-color:var(--teal); }

/* ── SB / TB compact board inputs on scoring screen ─────────── */
.board-row {
  display:flex; gap:8px; align-items:center;
  padding:6px 0 2px;
  justify-content:center;
}
.board-field {
  display:flex; align-items:center; gap:5px;
}
.board-lbl {
  font-size:10px; font-weight:800; color:var(--t3);
  letter-spacing:0.5px; min-width:20px;
}
.board-input {
  width:44px; text-align:center;
  background:var(--bg3); border:1.5px solid var(--border2);
  border-radius:8px; padding:5px 4px;
  color:var(--t1); font-size:14px; font-weight:700;
  outline:none; -webkit-appearance:none;
}
.board-input:focus { border-color:var(--teal); }
.board-sep { width:1px; height:20px; background:var(--border1); }

/* ── Game date sub-label on scoring header ──────────────────── */
.game-date-sub {
  font-size:10px; color:var(--t3); font-weight:600;
  text-align:center; padding:2px 0 4px; letter-spacing:0.3px;
}

/* ── Open bowling screen ────────────────────────────────────── */
.open-session-card {
  background:var(--bg2); border:1px solid var(--border1);
  border-radius:16px; padding:14px 16px; margin-bottom:10px;
  cursor:pointer; transition:all 0.12s;
}
.open-session-card:active { background:var(--bg3); transform:scale(0.99); }
.open-session-hdr { display:flex; justify-content:space-between; align-items:center; }
.open-session-date { font-size:15px; font-weight:800; color:var(--t1); }
.open-session-center { font-size:12px; color:var(--t3); margin-top:2px; }
.open-session-total { font-size:22px; font-weight:900; color:var(--teal); }
.open-session-games { display:flex; gap:6px; margin-top:10px; flex-wrap:wrap; }

/* ── Settings ID seed section ────────────────────────────────── */
.seed-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;
}
.seed-field { display:flex; flex-direction:column; gap:4px; }
.seed-lbl { font-size:10px; font-weight:700; color:var(--t3); letter-spacing:0.5px; }
.seed-input {
  background:var(--bg3); border:1.5px solid var(--border2);
  border-radius:8px; padding:8px 10px;
  color:var(--t1); font-size:14px; font-weight:700;
  outline:none; -webkit-appearance:none; width:100%; box-sizing:border-box;
}
.seed-input:focus { border-color:var(--teal); }
.f10-indicator {
  text-align:center; padding:8px 14px;
  background:rgba(157,78,221,0.08);
  border:1px solid rgba(157,78,221,0.25);
  border-radius:12px; margin-bottom:10px;
  font-size:12px; color:var(--purple);
  font-weight:700; letter-spacing:0.5px;
}

/* ============================================================
   ANIMATIONS
   ============================================================ */
@keyframes pop {
  0%   { transform:scale(1); }
  40%  { transform:scale(1.12); }
  100% { transform:scale(1); }
}
@keyframes strikeFlash {
  0%,100% { opacity:1; }
  50%     { opacity:0.5; }
}
.pin-btn.K { animation:pop 0.2s ease; }
.att.X.new { animation:strikeFlash 0.4s ease; }

@keyframes scoreIn {
  from { transform:scale(0.7); opacity:0; }
  to   { transform:scale(1); opacity:1; }
}
.sc-tot.new { animation:scoreIn 0.3s cubic-bezier(0.34,1.56,0.64,1); }

</style>
</head>
<body>
<div id="app">

  <!-- HEADER -->
  <div id="hdr">
    <div id="hdr-back" onclick="navBack()">
      <svg width="11" height="19" viewBox="0 0 11 19" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9.5 1.5L1.5 9.5L9.5 17.5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div id="hdr-title"><span class="brand">Bowling</span>DB</div>
    <div id="hdr-right">
      <div class="hdr-icon-btn" id="hdr-sync-btn" onclick="openExportModal()" title="Export">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      </div>
      <div class="hdr-icon-btn" onclick="openSettingsModal()" title="Settings">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
        </svg>
      </div>
    </div>
  </div>

  <!-- SCREENS -->
  <div id="screens">

    <!-- HOME -->
    <div id="s-home" class="screen active" data-title="<span class='brand'>Bowling</span>DB">
      <div class="home-hero">
        <div class="home-logo">BowlingDB</div>
        <div class="home-sub">Pro Vibrant Edition</div>
      </div>
      <div class="qs-grid">
        <div class="qs-card"><div class="qs-val" id="qs-avg">—</div><div class="qs-lbl">Average</div></div>
        <div class="qs-card"><div class="qs-val" id="qs-games">—</div><div class="qs-lbl">Games</div></div>
        <div class="qs-card"><div class="qs-val" id="qs-high">—</div><div class="qs-lbl">High</div></div>
      </div>
      <div class="nav-grid">
        <!-- Leagues -->
        <div class="nav-tile" onclick="navTo('s-leagues')">
          <div class="nav-tile-icon-wrap" style="background:linear-gradient(135deg,rgba(157,78,221,0.28),rgba(0,217,217,0.18))">
            <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
              <defs><linearGradient id="g-L" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#9D4EDD"/><stop offset="100%" stop-color="#00D9D9"/></linearGradient></defs>
              <!-- Block letter L -->
              <rect x="7" y="5" width="4.5" height="18" rx="1.5" fill="url(#g-L)"/>
              <rect x="7" y="19" width="13" height="4.5" rx="1.5" fill="url(#g-L)"/>
            </svg>
          </div>
          <span class="nav-tile-txt">Leagues</span>
        </div>
        <!-- Open Bowling -->
        <div class="nav-tile" onclick="navTo('s-open')">
          <div class="nav-tile-icon-wrap" style="background:linear-gradient(135deg,rgba(0,217,217,0.22),rgba(0,160,160,0.15))">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10" stroke="url(#g-ob)"/>
              <circle cx="12" cy="12" r="3" stroke="url(#g-ob)"/>
              <defs><linearGradient id="g-ob" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#00D9D9"/><stop offset="100%" stop-color="#00A0A0"/></linearGradient></defs>
            </svg>
          </div>
          <span class="nav-tile-txt">Open Bowl</span>
        </div>
        <!-- Tournaments -->
        <div class="nav-tile" onclick="navTo('s-tournaments')">
          <div class="nav-tile-icon-wrap" style="background:linear-gradient(135deg,rgba(255,215,0,0.22),rgba(200,150,0,0.15))">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="url(#g-tr)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <defs><linearGradient id="g-tr" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#AA7800"/></linearGradient></defs>
              <polyline points="6 9 12 3 18 9"/><path d="M12 3v13"/><path d="M6 21h12"/><path d="M6 17h12"/>
            </svg>
          </div>
          <span class="nav-tile-txt">Tournament</span>
        </div>
        <!-- Stats -->
        <div class="nav-tile" onclick="navTo('s-stats')">
          <div class="nav-tile-icon-wrap" style="background:linear-gradient(135deg,rgba(0,217,217,0.18),rgba(157,78,221,0.18))">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="url(#g-st)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <defs><linearGradient id="g-st" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#00D9D9"/><stop offset="100%" stop-color="#9D4EDD"/></linearGradient></defs>
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
          </div>
          <span class="nav-tile-txt">Stats</span>
        </div>
        <!-- Export -->
        <div class="nav-tile" onclick="openExportModal()">
          <div class="nav-tile-icon-wrap" style="background:linear-gradient(135deg,rgba(232,93,76,0.18),rgba(157,78,221,0.12))">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="url(#g-ex)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <defs><linearGradient id="g-ex" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#E85D4C"/><stop offset="100%" stop-color="#9D4EDD"/></linearGradient></defs>
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
          </div>
          <span class="nav-tile-txt">Export</span>
        </div>
        <!-- Settings -->
        <div class="nav-tile" onclick="openSettingsModal()">
          <div class="nav-tile-icon-wrap" style="background:linear-gradient(135deg,rgba(255,255,255,0.08),rgba(157,78,221,0.12))">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="url(#g-cfg)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <defs><linearGradient id="g-cfg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#aaa"/><stop offset="100%" stop-color="#9D4EDD"/></linearGradient></defs>
              <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
          </div>
          <span class="nav-tile-txt">Settings</span>
        </div>
      </div>
      <div class="bsk-legend">
        <div class="leg-item"><div class="leg-dot base"></div>Base</div>
        <div class="leg-item"><div class="leg-dot stand"></div>Standing</div>
        <div class="leg-item"><div class="leg-dot knock"></div>Knocked</div>
      </div>
    </div>

    <!-- LEAGUES -->
    <div id="s-leagues" class="screen" data-title="Leagues">
      <div class="sec-header">
        <span class="sec-title">Leagues</span>
        <button class="add-btn" onclick="openNewLeagueModal()">+</button>
      </div>
      <div id="leagues-list"></div>
    </div>

    <!-- SERIES -->
    <div id="s-series" class="screen">
      <div class="sec-header">
        <span class="sec-title" id="series-title">Series</span>
        <button class="add-btn" onclick="openNewSeriesModal()">+</button>
      </div>
      <div id="series-list"></div>
    </div>

    <!-- GAME SELECT (within a series) -->
    <div id="s-game-select" class="screen">
      <div class="sec-header">
        <span class="sec-title" id="game-select-title">Games</span>
      </div>
      <div id="game-select-list"></div>
    </div>

    <!-- OPEN BOWLING -->
    <div id="s-open" class="screen" data-title="Open Bowling">
      <div class="sec-header">
        <span class="sec-title">Open Bowling</span>
        <button class="add-btn" onclick="openNewOpenSessionModal()">+</button>
      </div>
      <div id="open-list"></div>
    </div>

    <!-- TOURNAMENTS -->
    <div id="s-tournaments" class="screen" data-title="Tournaments">
      <div class="sec-header">
        <span class="sec-title">Tournaments</span>
        <button class="add-btn" onclick="openNewTournamentModal()">+</button>
      </div>
      <div id="tournament-list"></div>
    </div>

    <!-- SCORING -->
    <div id="s-scoring" class="screen" data-title="Game">

      <!-- NoTap display toggle (shown only when NoTap is ON) -->
      <div id="notap-display-toggle" style="display:none">
        <div class="sc-display-toggle">
          <div class="sc-dt-btn on" id="sc-dt-std" onclick="setScoreDisplay('standard')">Standard</div>
          <div class="sc-dt-btn" id="sc-dt-nt" onclick="setScoreDisplay('notap')">NoTap 9 <span class="notap-badge">NT</span></div>
        </div>
      </div>

      <!-- Scorecard - tap any frame cell to navigate there -->
      <div class="sc-wrap">
        <div class="sc-scroll"><div class="sc-grid" id="sc-grid"></div></div>
      </div>

      <!-- Attempt Navigation Bar -->
      <div class="att-nav" id="att-nav">
        <div class="att-nav-btn" id="nav-prev" onclick="navPrevAttempt()" title="Previous attempt">
          <svg width="9" height="16" viewBox="0 0 9 16" fill="none"><path d="M7.5 1L1 8l6.5 7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="att-nav-center">
          <div class="att-nav-label">Frame <span id="nav-frame">1</span> · Attempt <span id="nav-att">1</span></div>
          <div id="nav-mode-pill" class="att-nav-modepill FRESH">LEAVE</div>
        </div>
        <div class="att-nav-btn" id="nav-next" onclick="navNextAttempt()" title="Next attempt">
          <svg width="9" height="16" viewBox="0 0 9 16" fill="none"><path d="M1.5 1L8 8l-6.5 7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="notes-icon-btn" id="notes-icon-btn" onclick="openAttemptNotesModal()" title="Attempt Notes" style="margin-left:6px">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
        </div>
      </div>

      <!-- Mode instruction banner -->
      <div class="mode-instruction FRESH" id="mode-instruction">
        Tap pins that are <strong>still standing</strong> after your shot
      </div>

      <!-- Frame 10 scenario indicator -->
      <div class="f10-indicator" id="f10-ind" style="display:none"></div>

      <!-- Pinfall readout + running score -->
      <div class="pf-display">
        <div>
          <div class="pf-big" id="pf-num">0</div>
          <div class="pf-lbl" id="pf-lbl">Pins Knocked</div>
        </div>
        <div class="pf-right">
          <div style="font-size:9px;font-weight:700;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:2px">Running</div>
          <div style="font-size:26px;font-weight:900;color:var(--teal)" id="ctx-score">—</div>
        </div>
      </div>

      <!-- Board tracking: Starting Board / Target Board -->
      <div class="board-row" id="board-row">
        <div class="board-field">
          <span class="board-lbl">SB</span>
          <input class="board-input" id="board-sb" type="number" min="1" max="39" placeholder="—"
            onchange="saveBoardData()" inputmode="numeric">
        </div>
        <div class="board-sep"></div>
        <div class="board-field">
          <span class="board-lbl">TB</span>
          <input class="board-input" id="board-tb" type="number" min="1" max="39" placeholder="—"
            onchange="saveBoardData()" inputmode="numeric">
        </div>
      </div>

      <!-- Quick Actions (Strike / Spare / Gutter) -->
      <div class="qa-row">
        <button class="qa-btn qa-strike" id="qa-primary" onclick="quickPrimary()">Strike ✕</button>
        <button class="qa-btn qa-spare" id="qa-spare" onclick="quickSpare()">Spare /</button>
        <button class="qa-btn qa-miss" id="qa-secondary" onclick="quickSecondary()">Gutter —</button>
      </div>

      <!-- Confirm button -->
      <button class="btn btn-primary" id="btn-confirm" onclick="confirmAttempt()">Confirm →</button>

      <!-- Pin Triangle -->
      <div class="pin-stage" id="pin-stage">
        <div class="pin-row">
          <button class="pin-btn" id="pb7" onclick="togglePin(7)">7</button>
          <button class="pin-btn" id="pb8" onclick="togglePin(8)">8</button>
          <button class="pin-btn" id="pb9" onclick="togglePin(9)">9</button>
          <button class="pin-btn" id="pb10" onclick="togglePin(10)">10</button>
        </div>
        <div class="pin-row">
          <button class="pin-btn" id="pb4" onclick="togglePin(4)">4</button>
          <button class="pin-btn" id="pb5" onclick="togglePin(5)">5</button>
          <button class="pin-btn" id="pb6" onclick="togglePin(6)">6</button>
        </div>
        <div class="pin-row">
          <button class="pin-btn" id="pb2" onclick="togglePin(2)">2</button>
          <button class="pin-btn" id="pb3" onclick="togglePin(3)">3</button>
        </div>
        <div class="pin-row">
          <button class="pin-btn" id="pb1" onclick="togglePin(1)">1</button>
        </div>
      </div>

      <!-- Undo bar -->
      <div class="undo-bar" id="undo-bar">
        <span class="undo-txt" id="undo-txt">Attempt recorded</span>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="undo-countdown" id="undo-countdown">3</div>
          <button class="undo-btn" onclick="doUndo()">Undo</button>
        </div>
      </div>

      <!-- Ball bar -->
      <div class="ball-bar">
        <div class="ball-info"><div class="ball-icon"></div><span id="ball-name-display">Select Ball</span></div>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="display:flex;align-items:center;gap:6px;cursor:pointer" onclick="toggleNoTap()" title="NoTap Mode">
            <span style="font-size:11px;font-weight:700;color:var(--t3)" id="notap-label">NoTap</span>
            <div class="toggle-switch" id="notap-toggle"></div>
          </div>
          <span class="ball-change" onclick="openBallModal()">Change</span>
        </div>
      </div>
    </div>

    <!-- GAME COMPLETE -->
    <div id="s-game-complete" class="screen" data-title="Game Complete">
      <div class="sc-wrap">
        <div class="sc-scroll"><div class="sc-grid" id="sc-grid-complete"></div></div>
      </div>
      <div class="card gc-hero">
        <div class="gc-score" id="gc-score">—</div>
        <div class="gc-lbl">Final Score</div>
        <div class="gc-diff" id="gc-diff"></div>
      </div>
      <div class="card" id="gc-stats"></div>
      <button class="btn btn-gold" id="btn-next-game" onclick="goNextGame()" style="display:none">Start Game 2 →</button>
      <button class="btn btn-primary" id="btn-end-series" onclick="endSeries()">View Series</button>
    </div>

    <!-- STATS -->
    <div id="s-stats" class="screen" data-title="Statistics">
      <div id="stats-content"></div>
    </div>

  </div><!-- /screens -->

  <!-- BOTTOM NAV -->
  <div id="bnav">
    <div class="bnav-item on" data-sc="s-home" onclick="navTo('s-home')">
      <div class="bnav-icon-wrap">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="bn-home" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#00D9D9"/><stop offset="100%" stop-color="#9D4EDD"/></linearGradient></defs>
          <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" stroke="url(#bn-home)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          <polyline points="9,22 9,12 15,12 15,22" stroke="url(#bn-home)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <span class="bnav-label">Home</span>
    </div>
    <div class="bnav-item" data-sc="s-leagues" onclick="navTo('s-leagues')">
      <div class="bnav-icon-wrap">
        <svg width="22" height="22" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="bn-lg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#9D4EDD"/><stop offset="100%" stop-color="#00D9D9"/></linearGradient></defs>
          <rect x="7" y="5" width="4.5" height="18" rx="1.5" fill="url(#bn-lg)"/>
          <rect x="7" y="19" width="13" height="4.5" rx="1.5" fill="url(#bn-lg)"/>
        </svg>
      </div>
      <span class="bnav-label">Leagues</span>
    </div>
    <div class="bnav-item" data-sc="s-stats" onclick="navTo('s-stats')">
      <div class="bnav-icon-wrap">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="bn-st" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#00D9D9"/><stop offset="100%" stop-color="#9D4EDD"/></linearGradient></defs>
          <polyline points="22,12 18,12 15,21 9,3 6,12 2,12" stroke="url(#bn-st)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <span class="bnav-label">Stats</span>
    </div>
    <div class="bnav-item" onclick="openExportModal()">
      <div class="bnav-icon-wrap">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="bn-ex" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#E85D4C"/><stop offset="100%" stop-color="#9D4EDD"/></linearGradient></defs>
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="url(#bn-ex)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <polyline points="17,8 12,3 7,8" stroke="url(#bn-ex)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="12" y1="3" x2="12" y2="15" stroke="url(#bn-ex)" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <span class="bnav-label">Export</span>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Modal -->
  <div class="modal-bg" id="modal-bg" onclick="handleModalBgClick(event)">
    <div class="modal-sheet" id="modal-sheet">
      <div class="modal-handle"></div>
      <div id="modal-body"></div>
    </div>
  </div>

</div><!-- /app -->

<script>
/* =============================================================
   DATA STORE
   ============================================================= */
const STORE_KEY = 'bowlingdb_v2';

function loadDB() {
  try {
    const raw = localStorage.getItem(STORE_KEY);
    const data = raw ? JSON.parse(raw) : buildFreshDB();
    return migrateDB(data);
  } catch { return buildFreshDB(); }
}

function buildFreshDB() {
  return {
    centers: [
      { CenterID:1, CenterName:'AMF Mesa Lanes', Address:'', City:'Mesa', State:'AZ', Zip:'', Lanes:40, LaneSurface:'Synthetic', Website:'', ProShop:false },
      { CenterID:2, CenterName:'Virtue Bowling Center', Address:'', City:'', State:'AZ', Zip:'', Lanes:24, LaneSurface:'Synthetic', Website:'', ProShop:false }
    ],
    leagues: [
      { LeagueID:1, LeagueName:'NFL 25/26', CenterID:1, GamesPerSeries:3, DayOfBowling:'Wednesday', Weeks:36, WeeklyDues:0, Active:true, DefaultBallID:1, Handicap:false, Sport:false, Notes:'', Archived:false },
      { LeagueID:2, LeagueName:'Virtue Fun Spring 2026', CenterID:2, GamesPerSeries:3, DayOfBowling:'Tuesday', Weeks:20, WeeklyDues:0, Active:true, DefaultBallID:1, Handicap:false, Sport:false, Notes:'', Archived:false }
    ],
    // Open bowling sessions — separate from leagues (tblOpenSessions concept)
    openSessions: [],
    // Tournaments — same structure as leagues but GameType='Tournament'
    tournaments: [],
    balls: [
      { BallID:1, BallName:'Envy Tour Pearl', Weight:15, MFG:'Motiv', Active:true },
      { BallID:2, BallName:'2-Trend Evo', Weight:15, MFG:'Roto Grip', Active:true },
      { BallID:3, BallName:'House Ball', Weight:14, MFG:'', Active:true }
    ],
    patterns: [],
    series: [], games: [], frames: [], attempts: [],
    // ID counters — start above 200 to avoid collision with existing Access records.
    // Editable via Settings → ID Seeds so you can sync with your real database.
    ids: { series:201, game:201, frame:1001, attempt:5001, center:3, league:3, ball:4, tournament:1, openSession:1, pattern:1 }
  };
}

/* Migrate existing db to add new fields if they're missing (handles upgrades) */
function migrateDB(data) {
  if (!data.openSessions) data.openSessions = [];
  if (!data.tournaments) data.tournaments = [];
  if (!data.patterns) data.patterns = [];
  if (!data.ids.center) data.ids.center = Math.max(0,...(data.centers||[]).map(c=>c.CenterID))+1;
  if (!data.ids.league) data.ids.league = Math.max(0,...(data.leagues||[]).map(l=>l.LeagueID))+1;
  if (!data.ids.ball) data.ids.ball = Math.max(0,...(data.balls||[]).map(b=>b.BallID))+1;
  if (!data.ids.tournament) data.ids.tournament = 1;
  if (!data.ids.openSession) data.ids.openSession = 1;
  if (!data.ids.pattern) data.ids.pattern = Math.max(0,...(data.patterns||[]).map(p=>p.PatternID),0)+1;
  if (!data.customPins) data.customPins = { B:null, S:null, K:null };
  // Ensure league fields exist
  (data.leagues||[]).forEach(l => {
    if (l.DayOfBowling===undefined) l.DayOfBowling = '';
    if (l.Weeks===undefined) l.Weeks = 0;
    if (l.WeeklyDues===undefined) l.WeeklyDues = 0;
    if (l.DefaultBallID===undefined) l.DefaultBallID = null;
    if (l.Handicap===undefined) l.Handicap = false;
    if (l.Sport===undefined) l.Sport = false;
    if (l.Notes===undefined) l.Notes = '';
    if (l.Archived===undefined) l.Archived = false;
  });
  // Ensure series fields exist
  (data.series||[]).forEach(s => {
    if (s.Notes===undefined) s.Notes = '';
    if (s.GameType===undefined) s.GameType = 'League';
  });
  // Ensure game fields exist
  (data.games||[]).forEach(g => {
    if (g.Notes===undefined) g.Notes = '';
    if (g.PatternID===undefined) g.PatternID = null;
    if (g.DateBowled===undefined) {
      const ser = data.series?.find(s=>s.SeriesID===g.SeriesID);
      g.DateBowled = ser?.DateBowled || null;
    }
  });
  // Ensure attempt fields
  (data.attempts||[]).forEach(a => {
    if (a.StartingBoard===undefined) a.StartingBoard = null;
    if (a.TargetBoard===undefined) a.TargetBoard = null;
  });
  return data;
}

function saveDB() { localStorage.setItem(STORE_KEY, JSON.stringify(db)); }
let db = loadDB();

/* =============================================================
   APP STATE — the single source of truth
   ============================================================= */
const G = {
  screenHistory: [],
  leagueID: null,
  seriesID: null,
  gameID: null,
  gameNum: 1,
  // Scoring state
  frame: 1,
  attempt: 1,
  // pinState[1..10]: 'S'=standing, 'B'=base(already down)
  pinState: {},
  // What user has tapped this attempt
  knocked: new Set(),
  // LEAVE mode: pins user has marked as still standing (attempt 1)
  leave: new Set(),
  // Lane setup
  laneStart: null,
  lanePair: null,
  oddLane: null,
  evenLane: null,
  // NoTap
  noTap: false,
  scoreDisplay: 'standard', // 'standard' or 'notap'
  // Selected ball
  ballID: null,
  // Undo state
  undoAvailable: false,
  undoSnapshot: null,
  undoTimer: null,
  undoTick: null,
  // Frame 10 scenario (computed)
  f10scenario: null,
};

/* =============================================================
   NAVIGATION ENGINE
   ============================================================= */
const ROOT_SCREENS = ['s-home','s-leagues','s-open','s-tournaments','s-stats'];

function navTo(screenId, opts={}) {
  if (!opts.back) G.screenHistory.push(getCurrentScreen());

  // Slide out current
  const cur = document.querySelector('.screen.active');
  if (cur && cur.id !== screenId) {
    cur.classList.remove('active');
    if (!opts.back) cur.classList.add('prev');
    else cur.classList.remove('prev');
    // clean prev class after animation
    setTimeout(()=> cur.classList.remove('prev'), 300);
  }

  // Slide in target
  const target = document.getElementById(screenId);
  if (!target) return;
  target.classList.add('active');
  target.scrollTop = 0;

  // Header back button
  const isRoot = ROOT_SCREENS.includes(screenId);
  document.getElementById('hdr-back').classList.toggle('show', !isRoot);

  // Header title
  const customTitle = target.dataset.title;
  if (customTitle) document.getElementById('hdr-title').innerHTML = customTitle;

  // Bottom nav
  document.querySelectorAll('.bnav-item').forEach(b =>
    b.classList.toggle('on', b.dataset.sc === screenId));

  // Screen-specific render
  ({
    'home': renderHome,
    's-home': renderHome,
    's-leagues': renderLeagues,
    's-open': renderOpenList,
    's-tournaments': renderTournamentList,
    's-series': renderSeriesList,
    's-game-select': renderGameSelect,
    's-scoring': renderScoringScreen,
    's-game-complete': renderGameComplete,
    's-stats': renderStats
  })[screenId]?.();
}

function getCurrentScreen() {
  return document.querySelector('.screen.active')?.id || 's-home';
}

function navBack() {
  const prev = G.screenHistory.pop();
  if (prev) navTo(prev, { back:true });
  else navTo('s-home', { back:true });
}

/* =============================================================
   HOME
   ============================================================= */
function renderHome() {
  document.getElementById('hdr-title').innerHTML = "<span class='brand'>Bowling</span>DB";
  const scores = db.games.map(g=>g.FinalScore).filter(s=>s!=null);
  document.getElementById('qs-avg').textContent = scores.length
    ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : '—';
  document.getElementById('qs-games').textContent = scores.length || '—';
  document.getElementById('qs-high').textContent = scores.length ? Math.max(...scores) : '—';
}

/* =============================================================
   LEAGUES
   ============================================================= */
let G_showArchived = false; // module-level toggle

function renderLeagues() {
  const el = document.getElementById('leagues-list');
  const all = db.leagues;
  const visible = all.filter(l => G_showArchived || !l.Archived);

  let html = `<div class="show-archived-row">
    <span>Show archived</span>
    <div class="toggle-switch ${G_showArchived?'on':''}" onclick="toggleShowArchived()"></div>
  </div>`;

  if (!visible.length) {
    html += `<div class="empty-state"><div class="empty-icon">🏆</div>
      <div class="empty-label">${G_showArchived?'No leagues':'No active leagues'}</div>
      <div class="empty-sub">Tap + to add a league</div></div>`;
    el.innerHTML = html;
    return;
  }

  visible.forEach(l => {
    const center = db.centers.find(c=>c.CenterID===l.CenterID);
    const sCount = db.series.filter(s=>s.LeagueID===l.LeagueID).length;
    const meta = [
      center?.CenterName,
      l.DayOfBowling,
      l.Weeks ? `${l.Weeks}wk` : null,
      sCount ? `${sCount} series` : null
    ].filter(Boolean).join(' · ');

    html += `<div class="series-card-wrap">
      <div class="series-card${l.Archived?' league-archived':''}" onclick="selectLeague(${l.LeagueID})">
        <div class="series-hdr" style="align-items:flex-start">
          <div>
            <div class="list-row-name" style="font-size:16px;font-weight:800">
              ${l.LeagueName}
              ${l.Archived?'<span class="archived-badge">archived</span>':''}
            </div>
            <div class="list-row-meta" style="margin-top:2px">${meta}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            ${l.GamesPerSeries ? `<span class="pill pill-teal" style="font-size:10px">${l.GamesPerSeries}G</span>` : ''}
          </div>
        </div>
      </div>
      <div class="series-card-actions">
        <div class="sc-act-btn stats-btn" onclick="openLeagueStatsModal(${l.LeagueID})">📊 Stats</div>
        <div class="sc-act-btn edit" onclick="openEditLeagueModal(${l.LeagueID})">Edit</div>
        <div class="sc-act-btn" onclick="toggleArchiveLeague(${l.LeagueID})">${l.Archived?'Unarchive':'Archive'}</div>
      </div>
    </div>`;
  });

  el.innerHTML = html;
}

function toggleShowArchived() {
  G_showArchived = !G_showArchived;
  renderLeagues();
}

function toggleArchiveLeague(id) {
  const l = db.leagues.find(x=>x.LeagueID===id);
  if (!l) return;
  l.Archived = !l.Archived;
  saveDB(); renderLeagues();
  toast(l.Archived ? 'League archived' : 'League restored');
}

function openLeagueStatsModal(leagueID) {
  const l = db.leagues.find(x=>x.LeagueID===leagueID);
  if (!l) return;
  const center = db.centers.find(c=>c.CenterID===l.CenterID);
  const allSeries = db.series.filter(s=>s.LeagueID===leagueID);
  const allGames  = db.games.filter(g=>g.LeagueID===leagueID && g.FinalScore!=null);
  const scores = allGames.map(g=>g.FinalScore);
  const total  = scores.reduce((a,b)=>a+b,0);
  const avg    = scores.length ? Math.round(total/scores.length) : 0;
  const high   = scores.length ? Math.max(...scores) : 0;
  const low    = scores.length ? Math.min(...scores) : 0;

  // Frame-level stats across all games in league (frames 1-9 only)
  const allFrames = db.frames.filter(f =>
    f.FrameNumber <= 9 && allGames.some(g=>g.GameID===f.GameID));
  const strikes  = allFrames.filter(f=>f.Strike).length;
  const spares   = allFrames.filter(f=>f.Spare).length;
  const opens    = allFrames.filter(f=>!f.Strike&&!f.Spare).length;
  const spOpp    = allFrames.filter(f=>!f.Strike).length;
  const spRate   = spOpp > 0 ? Math.round(spares/spOpp*100) : 0;
  const strRate  = allFrames.length ? Math.round(strikes/allFrames.length*100) : 0;

  // Best series total
  const seriesTotals = allSeries.map(s => {
    const gs = db.games.filter(g=>g.SeriesID===s.SeriesID && g.FinalScore!=null);
    return gs.reduce((a,g)=>a+g.FinalScore,0);
  }).filter(t=>t>0);
  const bestSeries = seriesTotals.length ? Math.max(...seriesTotals) : 0;

  openModal(`
    <div class="modal-title">${l.LeagueName}</div>
    <div style="font-size:11px;color:var(--t3);margin-bottom:14px">${center?.CenterName||''} · ${l.DayOfBowling||''} · ${allSeries.length} series · ${allGames.length} games${l.Handicap?' · <span style="color:var(--teal)">Handicap</span>':''}${l.Sport?' · <span style="color:var(--purple)">Sport</span>':''}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px;text-align:center">
      <div class="stat-card" style="padding:10px 6px">
        <div class="stat-card-title">Average</div>
        <div style="font-size:22px;font-weight:900;color:var(--teal)">${avg||'—'}</div>
      </div>
      <div class="stat-card" style="padding:10px 6px">
        <div class="stat-card-title">High</div>
        <div style="font-size:22px;font-weight:900;color:var(--gold)">${high||'—'}</div>
      </div>
      <div class="stat-card" style="padding:10px 6px">
        <div class="stat-card-title">Best Set</div>
        <div style="font-size:22px;font-weight:900;color:var(--purple)">${bestSeries||'—'}</div>
      </div>
    </div>
    <div class="stat-row"><span>Games Bowled</span><span class="sval t">${allGames.length}</span></div>
    <div class="stat-row"><span>Strike Rate (F1–9)</span><span class="sval g">${strRate}%</span></div>
    <div class="stat-row"><span>Spare Rate</span><span class="sval t">${spRate}%</span></div>
    <div class="stat-row"><span>Strikes</span><span class="sval g">${strikes}</span></div>
    <div class="stat-row"><span>Spares</span><span class="sval t">${spares}</span></div>
    <div class="stat-row"><span>Opens</span><span class="sval s">${opens}</span></div>
    <div class="stat-row"><span>Low Game</span><span class="sval s">${low||'—'}</span></div>
    <button class="btn btn-secondary" onclick="closeModal()" style="margin-top:16px">Close</button>
  `);
}

function selectLeague(id) {
  G.leagueID = id;
  const l = db.leagues.find(x=>x.LeagueID===id);
  document.getElementById('series-title').textContent = l?.LeagueName||'Series';
  document.getElementById('hdr-title').textContent = l?.LeagueName||'Series';
  navTo('s-series');
}

/* =============================================================
   SERIES LIST
   ============================================================= */
function renderSeriesList() {
  const el = document.getElementById('series-list');
  const mySeries = db.series.filter(s=>s.LeagueID===G.leagueID)
    .sort((a,b)=>new Date(b.DateBowled)-new Date(a.DateBowled));

  if (!mySeries.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">📅</div><div class="empty-label">No series yet</div><div class="empty-sub">Tap + to start bowling</div></div>`;
    return;
  }
  el.innerHTML = mySeries.map(s => {
    const games = db.games.filter(g=>g.SeriesID===s.SeriesID).sort((a,b)=>a.GameNumber-b.GameNumber);
    const scores = games.map(g=>g.FinalScore).filter(x=>x!=null);
    const total = scores.reduce((a,b)=>a+b,0);
    const d = new Date(s.DateBowled);
    const dateStr = d.toLocaleDateString('en-US',{month:'numeric',day:'numeric',year:'2-digit'});
    const center = db.centers.find(c=>c.CenterID===s.CenterID);

    const badges = games.map(g => {
      if (g.FinalScore!=null) return `<div class="game-badge done">${g.FinalScore}</div>`;
      const anyAttempt = db.attempts.some(a=>a.GameID===g.GameID && a.Pinfall!=null);
      if (anyAttempt) return `<div class="game-badge inprog">In Prog</div>`;
      return `<div class="game-badge empty">—</div>`;
    }).join('');

    const league = db.leagues.find(l=>l.LeagueID===G.leagueID);
    const emptyCount = Math.max(0,(league?.GamesPerSeries||3) - games.length);
    const emptyBadges = Array(emptyCount).fill(`<div class="game-badge empty">—</div>`).join('');

    return `<div class="series-card-wrap">
      <div class="series-card" onclick="selectSeries(${s.SeriesID})">
        <div class="series-hdr">
          <div>
            <span class="series-date">${dateStr}</span>
            ${center ? `<div style="font-size:10px;color:var(--t3);margin-top:1px">${center.CenterName}</div>` : ''}
            <div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap">
              ${s.LanePair ? `<span class="pill pill-teal" style="font-size:10px">🎳 ${s.LanePair}</span>` : ''}
              ${s.NoTap ? `<span class="pill pill-gold" style="font-size:10px">✦ NoTap</span>` : ''}
              ${s.Notes ? `<span class="pill" style="font-size:10px;color:var(--t3)">📝</span>` : ''}
            </div>
          </div>
          <span class="series-total">${total||'...'}</span>
        </div>
        <div class="series-games">${badges}${emptyBadges}</div>
      </div>
      <div class="series-card-actions">
        <div class="sc-act-btn stats-btn" onclick="openSeriesStatsModal(${s.SeriesID});event.stopPropagation()">📊 Stats</div>
        <div class="sc-act-btn edit" onclick="openEditSeriesModal(${s.SeriesID});event.stopPropagation()">Edit</div>
      </div>
    </div>`;
  }).join('');
}

function selectSeries(id) {
  G.seriesID = id;
  navTo('s-game-select');
}

/* =============================================================
   GAME SELECT
   ============================================================= */
function renderGameSelect() {
  const league = db.leagues.find(l=>l.LeagueID===G.leagueID);
  const series = db.series.find(s=>s.SeriesID===G.seriesID);
  const seriesDate = series?.DateBowled
    ? new Date(series.DateBowled).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})
    : '';
  document.getElementById('game-select-title').textContent = 'Games';
  document.getElementById('hdr-title').textContent = league?.LeagueName||'Games';

  const games = db.games.filter(g=>g.SeriesID===G.seriesID).sort((a,b)=>a.GameNumber-b.GameNumber);
  const maxGames = league?.GamesPerSeries||3;
  const el = document.getElementById('game-select-list');

  let html = seriesDate ? `<div class="game-date-sub">${seriesDate}</div>` : '';

  games.forEach(g => {
    const done = g.FinalScore != null;
    const meta = done ? `Score: ${g.FinalScore}` : 'In Progress — Tap to Continue';
    const metaColor = done ? 'var(--teal)' : 'var(--gold)';
    const dateLbl = g.DateBowled && g.DateBowled !== series?.DateBowled
      ? `<span style="font-size:10px;color:var(--t3);margin-left:8px">${new Date(g.DateBowled).toLocaleDateString('en-US',{month:'numeric',day:'numeric',year:'2-digit'})}</span>` : '';
    html += `<div class="game-row-wrap">
      <div class="list-row" onclick="openGame(${g.GameID}, ${g.GameNumber})">
        <div class="list-row-body">
          <div class="list-row-name">Game ${g.GameNumber}${dateLbl}</div>
          <div class="list-row-meta" style="color:${metaColor}">${meta}${g.PatternID ? ` · ${db.patterns.find(p=>p.PatternID===g.PatternID)?.PatternName||'Pattern #'+g.PatternID}` : ''}</div>
        </div>
        <span class="list-row-chevron">›</span>
      </div>
      <div class="game-row-actions">
        <div class="gr-act-btn edit" onclick="openEditGameModal(${g.GameID});event.stopPropagation()">Edit</div>
      </div>
    </div>`;
  });

  if (games.length < maxGames) {
    html += `<div class="list-row list-row-dashed" onclick="createAndStartGame()">
      <div class="list-row-body">
        <div class="list-row-name" style="color:var(--teal)">+ Start Game ${games.length+1}</div>
        <div class="list-row-meta">Begin scoring</div>
      </div>
    </div>`;
  }
  el.innerHTML = html;
}

function openEditGameModal(gameID) {
  const g = db.games.find(x=>x.GameID===gameID);
  if (!g) return;
  const cOpts = db.centers.map(c=>`<option value="${c.CenterID}"${g.CenterID===c.CenterID?' selected':''}>${c.CenterName}</option>`).join('');
  const bOpts = `<option value="">— Not set —</option>` + db.balls.map(b=>`<option value="${b.BallID}"${g.BallID===b.BallID?' selected':''}>${b.BallName}</option>`).join('');
  const pOpts = `<option value="">— None —</option>` + (db.patterns||[]).map(p=>`<option value="${p.PatternID}"${g.PatternID===p.PatternID?' selected':''}>${p.PatternName}</option>`).join('');
  openModal(`
    <div class="modal-title">Edit Game ${g.GameNumber}</div>
    <div class="fgroup"><label class="flabel">Lane</label>
      <input class="finput" id="eg-lane" type="text" placeholder="e.g. 15" value="${g.LaneStart||''}"></div>
    <div class="fgroup"><label class="flabel">Ball Used</label>
      <select class="finput" id="eg-ball">${bOpts}</select></div>
    <div class="fgroup"><label class="flabel">Center</label>
      <select class="finput" id="eg-center">${cOpts}</select></div>
    <div class="fgroup"><label class="flabel">Oil Pattern</label>
      <select class="finput" id="eg-pattern">${pOpts}</select></div>
    <div class="fgroup"><label class="flabel">Notes</label>
      <input class="finput" id="eg-notes" type="text" placeholder="Optional notes" value="${g.Notes||''}"></div>
    <button class="btn btn-primary" onclick="saveGameEdits(${gameID})">Save Changes</button>
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
  `);
}

function saveGameEdits(gameID) {
  const g = db.games.find(x=>x.GameID===gameID);
  if (!g) return;
  const laneRaw = document.getElementById('eg-lane').value.trim();
  g.LaneStart = laneRaw ? parseInt(laneRaw) : g.LaneStart;
  const ballRaw = document.getElementById('eg-ball').value;
  g.BallID = ballRaw ? parseInt(ballRaw) : null;
  g.CenterID = parseInt(document.getElementById('eg-center').value);
  const patRaw = document.getElementById('eg-pattern').value;
  g.PatternID = patRaw ? parseInt(patRaw) : null;
  g.Notes = document.getElementById('eg-notes').value.trim();
  saveDB(); closeModal(); renderGameSelect(); toast('Game updated!');
}

function createAndStartGame() {
  const series = db.series.find(s=>s.SeriesID===G.seriesID);
  const existing = db.games.filter(g=>g.SeriesID===G.seriesID);
  const gameNum = existing.length + 1;
  const gameID = db.ids.game++;

  // Lane alternation logic: game 1 = LaneStart, game 2 = other lane, game 3 = LaneStart, etc.
  let gameLane = null;
  if (series?.LaneStart && series?.LanePair) {
    const parts = series.LanePair.split('-').map(Number);
    const oddLane = parts[0], evenLane = parts[1];
    const startLane = series.LaneStart;
    const altLane = (startLane === oddLane) ? evenLane : oddLane;
    gameLane = (gameNum % 2 === 1) ? startLane : altLane;
  }

  db.games.push({
    GameID:gameID, SeriesID:G.seriesID, GameNumber:gameNum,
    LeagueID:G.leagueID, CenterID:series?.CenterID||1,
    FinalScore:null, GameTotal:null, LanePair:series?.LanePair||null,
    LaneStart:gameLane, NoTap:series?.NoTap||false
  });

  // Create 10 frames + attempts
  for (let fn=1; fn<=10; fn++) {
    const fid = db.ids.frame++;
    db.frames.push({ FrameID:fid, GameID:gameID, FrameNumber:fn, Strike:false, Spare:false, FrameScore:null, RunningTotal:null });
    const attCount = fn===10 ? 3 : 2;
    for (let an=1; an<=attCount; an++) {
      db.attempts.push(blankAttempt(db.ids.attempt++, fid, fn, gameNum, gameID, an));
    }
  }
  saveDB();
  openGame(gameID, gameNum);
}

function blankAttempt(id, fid, fn, gn, gid, an) {
  const a = { AttemptID:id, FrameID:fid, FrameNumber:fn, GameNumber:gn, GameID:gid, Attempt:an,
    Pinfall:null, LeaveID:null, BallID:null, BSK_Progressive:null, AttemptNotes:'',
    StartingBoard:null, TargetBoard:null };
  for (let p=1;p<=10;p++) {
    a[`Pin${p}`]=null; a[`PinStart${p}`]=null; a[`PinDelta${p}`]=null;
  }
  return a;
}

function openGame(gameID, gameNum) {
  G.gameID = gameID;
  G.gameNum = gameNum;
  const game = db.games.find(g=>g.GameID===gameID);
  G.noTap = game?.NoTap || false;
  G.scoreDisplay = 'standard';
  initScoringState();
  document.getElementById('hdr-title').textContent = `Game ${gameNum}`;
  navTo('s-scoring');
}

/* =============================================================
   SCORING STATE MACHINE — INIT
   ============================================================= */
function initScoringState() {
  G.frame = 1; G.attempt = 1;
  G.knocked = new Set();
  G.leave = new Set();
  G.pinState = freshPins();
  G.f10scenario = null;
  cancelUndo();

  // Find earliest incomplete attempt
  const frames = gameFrames().sort((a,b)=>a.FrameNumber-b.FrameNumber);
  for (const fr of frames) {
    const atts = frameAttempts(fr.FrameID);
    for (const at of atts) {
      if (at.Pinfall === null) {
        G.frame = fr.FrameNumber;
        G.attempt = at.Attempt;
        rebuildPinStateForCurrentAttempt();
        return;
      }
    }
  }
  // If all attempts filled, game is done
  finishGame();
}

function freshPins() {
  const p = {};
  for (let i=1;i<=10;i++) p[i]='S'; // S = standing
  return p;
}

/* =============================================================
   PIN STATE REBUILD
   Based on database — called when resuming a game mid-entry
   Mirrors modBSKCore fresh/progressive logic exactly
   ============================================================= */
function rebuildPinStateForCurrentAttempt() {
  G.pinState = freshPins();
  G.knocked = new Set();

  if (G.attempt === 1) return; // Always fresh for attempt 1

  const frame = getFrame(G.frame);
  if (!frame) return;
  const atts = frameAttempts(frame.FrameID);

  if (G.frame <= 9) {
    // Att 2: inherit from att 1
    const a1 = atts.find(a=>a.Attempt===1);
    if (a1 && a1.Pinfall !== null) applyPreviousAttempt(a1);
  } else {
    // Frame 10: fresh/progressive logic per scenario
    const a1 = atts.find(a=>a.Attempt===1);
    const a2 = atts.find(a=>a.Attempt===2);
    if (G.attempt === 2) {
      if (a1?.Pinfall === 10) {
        G.pinState = freshPins(); // X → fresh for att2
      } else {
        applyPreviousAttempt(a1);
      }
    } else if (G.attempt === 3) {
      if (a2?.Pinfall === 10) {
        G.pinState = freshPins(); // X on att2 → fresh for att3
      } else {
        applyPreviousAttempt(a2);
      }
    }
  }
}

function applyPreviousAttempt(att) {
  if (!att) return;
  for (let p=1;p<=10;p++) {
    if (att[`PinDelta${p}`] === 1) G.pinState[p] = 'B'; // knocked in prev attempt
  }
}

/* =============================================================
   IS-FRESH LOGIC  (mirrors VBA Frame 10 scenario table)
   ============================================================= */
function isFreshAttempt() {
  if (G.attempt === 1) return true;
  if (G.frame <= 9) return false; // att 2 in F1-9 is always spare
  // Frame 10
  const frame = getFrame(10);
  const atts = frameAttempts(frame?.FrameID);
  const a1 = atts.find(a=>a.Attempt===1);
  const a2 = atts.find(a=>a.Attempt===2);
  if (G.attempt === 2) return (a1?.Pinfall === 10); // X on att1 → fresh
  if (G.attempt === 3) return (a2?.Pinfall === 10); // X on att2 → fresh
  return false;
}

/* =============================================================
   ATTEMPT MODE — drives all pin interaction and display logic
   
   FRESH:  Attempt 1 on a genuinely fresh rack (all 10 pins up).
           Also applies to Frame 10 attempts that reset to fresh
           (XX_, X#/, #/_ after a strike on att2, etc.)
   LEAVE:  Attempt 1 on a non-fresh-rack scenario — impossible in
           standard bowling, but kept as alias. In practice,
           Attempt 1 is always FRESH. We use LEAVE as the
           interaction MODE for Attempt 1: user marks REMAINING
           pins (leave), not pins knocked.
   SPARE:  Attempt 2+ on a non-fresh rack. User marks pins KNOCKED.
   ============================================================= */
function getAttemptMode() {
  // Attempt 1 (and fresh F10 attempts) → LEAVE mode
  // (User taps what's still standing, i.e. their leave)
  if (isFreshAttempt()) return 'LEAVE';
  // Attempt 2+ on inherited pin state → SPARE mode
  // (User taps what they knocked)
  return 'SPARE';
}

/* =============================================================
   PIN INTERACTION — DUAL MODE
   
   LEAVE mode (Attempt 1 / fresh rack):
     All pins start as "will be knocked" (dark/base visual).
     User taps pins that are STILL STANDING after the shot.
     Tapped = gold/standing. Un-tapped = knocked (teal glow when confirmed).
     G.leave tracks which pins are still standing.
     Pinfall = 10 - G.leave.size
   
   SPARE mode (Attempt 2+ / inherited rack):
     Only standing pins (from previous attempt) are interactive.
     User taps pins they KNOCKED this attempt.
     G.knocked tracks what went down.
     Pinfall = G.knocked.size
   ============================================================= */

// G.leave: Set of pin numbers the user has marked as STILL STANDING (LEAVE mode)
// Initialized when entering LEAVE mode

function togglePin(p) {
  if (G.pinState[p] === 'B') return; // already down — not interactive
  haptic('light');

  const mode = getAttemptMode();

  if (mode === 'LEAVE') {
    // Toggle whether this pin is part of the leave (still standing)
    if (G.leave.has(p)) {
      G.leave.delete(p);  // Pin is now considered knocked
    } else {
      G.leave.add(p);     // Pin is now marked as leave (still standing)
    }
    // Derive knocked from leave: anything standing (S) that's NOT in leave = knocked
    G.knocked = new Set();
    for (let i=1;i<=10;i++) {
      if (G.pinState[i] === 'S' && !G.leave.has(i)) G.knocked.add(i);
    }
  } else {
    // SPARE mode: toggle knocked status directly
    if (G.knocked.has(p)) {
      G.knocked.delete(p);
    } else {
      G.knocked.add(p);
    }
  }

  updatePinDisplay();
  updatePinfallDisplay();
  // Live-update the current frame's BSK triangle in the scorecard
  refreshCurrentFrameBSK();
}

function quickPrimary() {
  const mode = getAttemptMode();
  if (mode === 'LEAVE') {
    // "Strike" — clear all leave (all pins knocked)
    G.leave = new Set();
    G.knocked = new Set();
    for (let p=1;p<=10;p++) {
      if (G.pinState[p] === 'S') G.knocked.add(p);
    }
    updatePinDisplay(); updatePinfallDisplay(); refreshCurrentFrameBSK();
    haptic('medium');
    confirmAttempt();
  } else {
    quickSpare();
  }
}

function quickSecondary() {
  const mode = getAttemptMode();
  if (mode === 'LEAVE') {
    // "All Miss" — mark all pins as still standing (gutter ball / zero pinfall)
    G.leave = new Set();
    for (let p=1;p<=10;p++) {
      if (G.pinState[p] === 'S') G.leave.add(p);
    }
    G.knocked = new Set();
    updatePinDisplay(); updatePinfallDisplay(); refreshCurrentFrameBSK();
    haptic('light');
    confirmAttempt();
  } else {
    // SPARE miss: zero knocked
    G.knocked = new Set();
    updatePinDisplay(); updatePinfallDisplay(); refreshCurrentFrameBSK();
    haptic('light');
    confirmAttempt();
  }
}

// Keep quickStrike and quickMiss as aliases for backward compat
function quickStrike() { quickPrimary(); }
function quickMiss()   { quickSecondary(); }
function quickSpare()  {
  // Called directly by qa-spare button — only valid in SPARE mode
  const mode = getAttemptMode();
  if (mode !== 'SPARE') return;
  G.knocked = new Set();
  for (let p=1;p<=10;p++) {
    if (G.pinState[p] === 'S') G.knocked.add(p);
  }
  updatePinDisplay(); updatePinfallDisplay();
  haptic('medium');
  confirmAttempt();
}

/* =============================================================
   CONFIRM ATTEMPT — CORE ENGINE
   ============================================================= */
function confirmAttempt() {
  cancelUndo();

  // In LEAVE mode, derive G.knocked from the leave set
  const mode = getAttemptMode();
  if (mode === 'LEAVE') {
    G.knocked = new Set();
    for (let p=1;p<=10;p++) {
      if (G.pinState[p] === 'S' && !G.leave.has(p)) G.knocked.add(p);
    }
  }

  const pinfall = G.knocked.size;
  const frame = getFrame(G.frame);
  if (!frame) { toast('Error: frame not found'); return; }
  const att = frameAttempts(frame.FrameID).find(a=>a.Attempt===G.attempt);
  if (!att) { toast('Error: attempt not found'); return; }

  // GUARDRAIL: frames 1-9, att2 is blocked if att1 was a strike
  if (G.frame <= 9 && G.attempt === 2) {
    const a1 = frameAttempts(frame.FrameID).find(a=>a.Attempt===1);
    if (a1 && a1.Pinfall === 10) {
      toast('Strike — no attempt 2 in this frame');
      return;
    }
  }

  // GUARDRAIL: pinfall can't exceed standing pins
  const standingCount = Object.values(G.pinState).filter(v=>v==='S').length;
  if (pinfall > standingCount) {
    toast(`Max ${standingCount} pins available`);
    return;
  }

  const isReEdit = att.Pinfall !== null; // Overwriting existing data

  // Save snapshot for undo
  G.undoSnapshot = JSON.stringify({
    db: JSON.parse(JSON.stringify(db)),
    G_frame: G.frame, G_attempt: G.attempt,
    G_pinState: {...G.pinState},
    G_knocked: [...G.knocked],
    G_leave: [...G.leave]
  });

  // If re-editing, clear all downstream attempts in this frame and later
  // so scoring stays consistent
  if (isReEdit) {
    clearDownstreamAttempts(G.frame, G.attempt);
  }

  // Write pin data
  for (let p=1;p<=10;p++) {
    att[`PinStart${p}`] = G.pinState[p] === 'S' ? 1 : 0;
    att[`PinDelta${p}`] = G.knocked.has(p) ? 1 : 0;
    att[`Pin${p}`] = G.knocked.has(p) ? true : false;
  }
  att.Pinfall = pinfall;
  att.BallID = G.ballID;
  att.BSK_Progressive = buildBSK();

  // Update frame flags
  updateFrameFlags(frame);
  calculateScores();
  saveDB();

  // Show undo bar
  showUndoBar(frame, att);

  // Advance state (only if not a re-edit of a past frame)
  if (!isReEdit) {
    advanceState();
  } else {
    // Re-edit: stay on current frame but update pin display
    G.knocked = new Set();
    G.leave = new Set();
  }

  // Refresh scorecard + UI
  renderScorecard('sc-grid', false);
  updatePinDisplay();
  updatePinfallDisplay();
  updateScoringContext();
  haptic('success');
}

/* Clear all attempts from (frameNum, attNum) onward — used when re-editing */
function clearDownstreamAttempts(fromFrame, fromAtt) {
  const frames = gameFrames().sort((a,b)=>a.FrameNumber-b.FrameNumber);
  for (const fr of frames) {
    const fn = fr.FrameNumber;
    const atts = frameAttempts(fr.FrameID);
    for (const a of atts) {
      // Skip attempts before our edit point
      if (fn < fromFrame) continue;
      if (fn === fromFrame && a.Attempt <= fromAtt) continue;
      // Clear this attempt
      a.Pinfall = null;
      a.BSK_Progressive = null;
      a.BallID = null;
      for (let p=1;p<=10;p++) {
        a[`Pin${p}`] = null;
        a[`PinStart${p}`] = null;
        a[`PinDelta${p}`] = null;
      }
    }
    // Also clear frame scores for affected frames
    if (fn >= fromFrame) {
      fr.FrameScore = null;
      fr.RunningTotal = null;
      fr.Strike = fn === fromFrame ? fr.Strike : false;
      fr.Spare = fn === fromFrame ? fr.Spare : false;
    }
  }
  // Update the game's FinalScore if it was set
  const game = db.games.find(g=>g.GameID===G.gameID);
  if (game) game.FinalScore = null;
}

/* =============================================================
   BSK ENGINE — mirrors modPinStartDelta.ConvertPinDataToBSK
   
   The fundamental rule (from spec Section 4.1 + truth table):
   
   For a FRESH RACK attempt (all pins standing before the shot):
     • Strike (all knocked): every pin = K
     • Non-strike: knocked pins = B, standing pins = S
   
   For a SPARE RACK attempt (some pins already down):
     • Already down (PinStart=0): B
     • Knocked this attempt: K
     • Still standing: S
   
   This applies to ALL attempts including F10 Att2/Att3 which can
   be either fresh or spare depending on the scenario.
   
   Truth table validation examples:
     X##  Att2 fresh non-strike → knocked=B, standing=S  ✓
     X#/  Att2 fresh non-strike → knocked=B, standing=S  ✓
     X#/  Att3 spare (convert)  → knocked=K              ✓
     XXX  Att2 fresh strike     → all K                  ✓
     #/X  Att3 fresh strike     → all K                  ✓
   ============================================================= */
function buildBSK() {
  // Detect fresh rack: no pin is in 'B' state (all were standing before shot)
  const isFreshRack = Object.values(G.pinState).every(v => v === 'S');
  const isStrike = isFreshRack && (G.knocked.size === 10);

  let bsk = '';
  for (let p = 1; p <= 10; p++) {
    const start = G.pinState[p]; // 'S' = standing before shot, 'B' = already down
    const knocked = G.knocked.has(p);

    if (start === 'B') {
      bsk += 'B'; // Was already down before this attempt — always B
    } else if (isStrike) {
      bsk += 'K'; // Strike: all knocked pins = K regardless of attempt number
    } else if (isFreshRack && knocked) {
      bsk += 'B'; // Fresh rack non-strike: knocked pins become Base
                  // (they're the background context for any subsequent spare attempt)
    } else if (!knocked) {
      bsk += 'S'; // Still standing after this attempt
    } else {
      bsk += 'K'; // Spare rack attempt: newly knocked = K (the scoring action)
    }
  }
  return bsk;
}

/* =============================================================
   FRAME FLAGS UPDATE
   ============================================================= */
function updateFrameFlags(frame) {
  const atts = frameAttempts(frame.FrameID);
  const a1 = atts.find(a=>a.Attempt===1);
  const a2 = atts.find(a=>a.Attempt===2);
  if (!a1 || a1.Pinfall===null) return;

  if (frame.FrameNumber <= 9) {
    frame.Strike = a1.Pinfall === 10;
    frame.Spare = !frame.Strike && a2?.Pinfall !== null && (a1.Pinfall + a2.Pinfall) >= 10;
  }
  // Frame 10 strike/spare flags not used for scoring here — handled inline
}

/* =============================================================
   STATE ADVANCE — The critical flow controller
   ============================================================= */
function advanceState() {
  const frame = getFrame(G.frame);
  const atts = frameAttempts(frame.FrameID);
  const a1 = atts.find(a=>a.Attempt===1);
  const a2 = atts.find(a=>a.Attempt===2);

  if (G.frame <= 9) {
    if (frame.Strike || G.attempt === 2) {
      // Frame complete → next frame
      G.frame++;
      G.attempt = 1;
      G.pinState = freshPins();
      G.knocked = new Set();
      G.leave = new Set();
    } else {
      // Move to attempt 2 — apply knocked pins as base
      G.attempt = 2;
      for (let p=1;p<=10;p++) {
        if (a1[`PinDelta${p}`] === 1) G.pinState[p] = 'B';
      }
      G.knocked = new Set();
      G.leave = new Set();
    }
  } else {
    // ========================================================
    // FRAME 10 — full scenario state machine
    // ========================================================
    if (G.attempt === 1) {
      G.attempt = 2;
      if (a1.Pinfall === 10) {
        // Strike → fresh pins for att2
        G.pinState = freshPins();
      } else {
        // Carry over standing pins
        for (let p=1;p<=10;p++) {
          if (a1[`PinDelta${p}`] === 1) G.pinState[p] = 'B';
        }
      }
      G.knocked = new Set();
      G.leave = new Set();

    } else if (G.attempt === 2) {
      const att1Strike = a1?.Pinfall === 10;
      const att2Pinfall = a2?.Pinfall ?? 0;
      const att2IsStrike = att2Pinfall === 10;
      const att1A2Spare = !att1Strike && (a1.Pinfall + att2Pinfall) >= 10;

      computeF10Scenario();

      if (att1Strike || att1A2Spare) {
        // Get bonus ball
        G.attempt = 3;
        if (att2IsStrike || att1A2Spare) {
          G.pinState = freshPins(); // Fresh if XX or #/
        } else {
          // X## → carry att2 standing pins
          for (let p=1;p<=10;p++) {
            if (a2[`PinDelta${p}`] === 1) G.pinState[p] = 'B';
          }
        }
        G.knocked = new Set();
        G.leave = new Set();
      } else {
        // ## — frame 10 done, no bonus
        finishGame();
        return;
      }

    } else if (G.attempt === 3) {
      finishGame();
      return;
    }
  }

  // Bounds check — past frame 10
  if (G.frame > 10) { finishGame(); return; }

  updatePinDisplay();
  updatePinfallDisplay();
  updateScoringContext();
}

/* =============================================================
   FRAME 10 SCENARIO
   ============================================================= */
function computeF10Scenario() {
  if (G.frame !== 10) return;
  const fr = getFrame(10);
  const atts = frameAttempts(fr?.FrameID);
  const a1 = atts.find(a=>a.Attempt===1);
  const a2 = atts.find(a=>a.Attempt===2);
  const a3 = atts.find(a=>a.Attempt===3);
  const p1 = a1?.Pinfall??null, p2 = a2?.Pinfall??null, p3 = a3?.Pinfall??null;

  if (p1===null) { G.f10scenario = null; return; }
  if (p1===10) {
    if (p2===null) { G.f10scenario='X__'; return; }
    if (p2===10) {
      G.f10scenario = p3===null ? 'XX_' : p3===10 ? 'XXX' : 'XX#';
    } else {
      if (p2+p3===10) G.f10scenario='X#/';
      else G.f10scenario='X##';
    }
  } else if (p2!==null && p1+p2===10) {
    if (p3===null) { G.f10scenario='#/__'; return; }
    G.f10scenario = p3===10 ? '#/X' : '#/#';
  } else {
    G.f10scenario = '##';
  }
}

/* =============================================================
   SCORE CALCULATION — forward-projection bowling scorer
   ============================================================= */
function calculateScores() {
  const frames = gameFrames().sort((a,b)=>a.FrameNumber-b.FrameNumber);
  let running = 0;

  for (let i=0; i<frames.length; i++) {
    const fr = frames[i];
    const atts = frameAttempts(fr.FrameID);
    const a1 = atts.find(a=>a.Attempt===1);
    const a2 = atts.find(a=>a.Attempt===2);
    const a3 = atts.find(a=>a.Attempt===3);
    const p1 = a1?.Pinfall, p2 = a2?.Pinfall, p3 = a3?.Pinfall;

    if (p1===null || p1===undefined) {
      fr.FrameScore = null; fr.RunningTotal = null; continue;
    }

    if (fr.FrameNumber <= 9) {
      if (fr.Strike) {
        const bonus = nextBalls(frames, i, 2);
        if (bonus===null) { fr.FrameScore=null; fr.RunningTotal=null; continue; }
        fr.FrameScore = 10 + bonus;
      } else if (fr.Spare) {
        const bonus = nextBalls(frames, i, 1);
        if (bonus===null) { fr.FrameScore=null; fr.RunningTotal=null; continue; }
        fr.FrameScore = 10 + bonus;
      } else {
        if (p2===null) { fr.FrameScore=null; fr.RunningTotal=null; continue; }
        fr.FrameScore = p1 + p2;
      }
    } else {
      // Frame 10: direct sum
      let sum = p1;
      if (p2!==null) sum += p2;
      if (p3!==null) sum += p3;
      fr.FrameScore = sum;
    }

    if (fr.FrameScore !== null) {
      running += fr.FrameScore;
      fr.RunningTotal = running;
    } else {
      fr.RunningTotal = null;
    }
  }
}

/* =============================================================
   NEXT BALLS — gets N bonus balls after frame at fromIdx
   KEY FIX: Only collects attempts with recorded Pinfall.
   Strike frames have att2/att3 with null Pinfall — we skip those
   by looking only at attempts that have been bowled (Pinfall!==null).
   We also respect that a strike frame contributes only 1 ball (att1).
   ============================================================= */
function nextBalls(frames, fromIdx, count) {
  const balls = [];
  for (let j = fromIdx + 1; j < frames.length && balls.length < count; j++) {
    const fr = frames[j];
    const atts = frameAttempts(fr.FrameID);
    if (fr.FrameNumber <= 9) {
      // In frames 1-9: only collect recorded balls
      // A strike frame contributes exactly 1 ball (att1=10, att2 never recorded)
      for (const a of atts) {
        if (a.Pinfall === null) {
          // If it's att1 being null → genuinely not yet bowled, stop here
          if (a.Attempt === 1) return null;
          // If it's att2 null in a strike frame → that's fine, just skip (no ball to collect)
          // If it's att2 null in a non-strike frame → not yet bowled, stop
          if (a.Attempt === 2 && !fr.Strike) return null;
          continue; // skip legitimately empty att2/att3 in strike frames
        }
        balls.push(a.Pinfall);
        if (balls.length >= count) break;
      }
    } else {
      // Frame 10: collect whatever is recorded
      for (const a of atts) {
        if (a.Pinfall === null) break; // stop at first unrecorded
        balls.push(a.Pinfall);
        if (balls.length >= count) break;
      }
    }
  }
  return balls.length >= count ? balls.slice(0, count).reduce((a,b)=>a+b,0) : null;
}

/* =============================================================
   FINISH GAME
   ============================================================= */
function finishGame() {
  calculateScores();
  const frames = gameFrames();
  const lastFrame = frames.find(f=>f.FrameNumber===10);
  const finalScore = lastFrame?.RunningTotal || 0;
  const game = db.games.find(g=>g.GameID===G.gameID);
  if (game) {
    game.FinalScore = finalScore;
    game.GameTotal = finalScore; // tblGames field alias
  }
  saveDB();
  navTo('s-game-complete');
}

/* =============================================================
   SCORING SCREEN RENDER
   ============================================================= */
function renderScoringScreen() {
  if (G.ballID) {
    const ball = db.balls.find(b=>b.BallID===G.ballID);
    document.getElementById('ball-name-display').textContent = ball?.BallName||'Select Ball';
  } else {
    document.getElementById('ball-name-display').textContent = 'Select Ball';
  }
  updateNoTapUI();
  renderScorecard('sc-grid', false);
  updatePinDisplay();
  updatePinfallDisplay();
  updateScoringContext();
  updateNotesIconState();
  loadBoardData(); // populate SB/TB from current attempt record
}

/* Save Starting Board / Target Board from the input fields to the current attempt record */
function saveBoardData() {
  const frame = getFrame(G.frame);
  if (!frame) return;
  const att = frameAttempts(frame.FrameID).find(a=>a.Attempt===G.attempt);
  if (!att) return;
  const sb = document.getElementById('board-sb')?.value;
  const tb = document.getElementById('board-tb')?.value;
  att.StartingBoard = sb ? parseInt(sb) : null;
  att.TargetBoard   = tb ? parseInt(tb) : null;
  saveDB(); // persist immediately — no undo needed for board data
}

/* Load SB/TB into the input fields from the current attempt record */
function loadBoardData() {
  const frame = getFrame(G.frame);
  if (!frame) return;
  const att = frameAttempts(frame.FrameID).find(a=>a.Attempt===G.attempt);
  const sbEl = document.getElementById('board-sb');
  const tbEl = document.getElementById('board-tb');
  if (sbEl) sbEl.value = att?.StartingBoard ?? '';
  if (tbEl) tbEl.value = att?.TargetBoard ?? '';
}

function updateScoringContext() {
  const mode = getAttemptMode();

  // Update nav bar
  const navFrame = document.getElementById('nav-frame');
  const navAtt = document.getElementById('nav-att');
  const navPill = document.getElementById('nav-mode-pill');
  if (navFrame) navFrame.textContent = G.frame;
  if (navAtt) navAtt.textContent = G.attempt;
  if (navPill) {
    navPill.textContent = mode;
    navPill.className = `att-nav-modepill ${mode}`;
  }

  // Prev/next nav button states
  updateNavButtons();

  // Show game + lane + date in header
  const game = db.games.find(g=>g.GameID===G.gameID);
  const laneStr = game?.LaneStart ? ` · Ln ${game.LaneStart}` : '';
  const ser = db.series.find(s=>s.SeriesID===G.seriesID);
  const dateStr = ser?.DateBowled
    ? ' · ' + new Date(ser.DateBowled).toLocaleDateString('en-US',{month:'numeric',day:'numeric'})
    : '';
  document.getElementById('hdr-title').textContent = `Game ${G.gameNum}${laneStr}${dateStr}`;

  // Instruction banner
  const banner = document.getElementById('mode-instruction');
  banner.className = `mode-instruction ${mode}`;
  if (mode === 'LEAVE') {
    banner.innerHTML = `Tap pins <strong>still standing</strong> after your shot &nbsp;·&nbsp; Leave Mode`;
  } else {
    banner.innerHTML = `Tap each pin you <strong>knocked down</strong> this attempt &nbsp;·&nbsp; Spare Mode`;
  }

  // Running score so far
  const frames = gameFrames();
  const latest = [...frames].filter(f=>f.RunningTotal!=null).sort((a,b)=>b.FrameNumber-a.FrameNumber)[0];
  const scoreEl = document.getElementById('ctx-score');
  if (scoreEl) scoreEl.textContent = latest?.RunningTotal ?? '—';

  // Quick action buttons — labels change per mode + guardrails
  updateQuickButtons(mode);

  // Frame 10 indicator
  const f10El = document.getElementById('f10-ind');
  if (G.frame === 10) {
    computeF10Scenario();
    f10El.style.display = 'block';
    const scenMap = {
      'X__': '⚡ Strike! — Fresh rack for Attempt 2',
      'XX_': '⚡⚡ Double! — Fresh rack for Attempt 3',
      'XXX': '🦃 Turkey!',
      'XX#': 'Double + spare attempt',
      'X#/': '⚡ Strike + Spare — Fresh for Att 3',
      'X##': '⚡ Strike + Open — Frame done',
      '#/__': 'Spare! — Strike or open for Att 3',
      '#/X': 'Spare + Strike! 🎳',
      '#/#': 'Spare + Open',
      '##':  'Open frame — Done',
      null:  ''
    };
    f10El.textContent = `Frame 10 · ${scenMap[G.f10scenario] || ''}`;
  } else {
    f10El.style.display = 'none';
  }

  updateNotesIconState();
  loadBoardData(); // refresh SB/TB fields when frame/attempt changes
}

/* =============================================================
   BOARD DATA — Starting Board / Target Board
   ============================================================= */
function updateQuickButtons(mode) {
  const primaryBtn = document.getElementById('qa-primary');
  const spareBtn = document.getElementById('qa-spare');
  const secondaryBtn = document.getElementById('qa-secondary');
  if (!primaryBtn) return;

  if (mode === 'LEAVE') {
    primaryBtn.textContent = 'Strike ✕';
    primaryBtn.className = 'qa-btn qa-strike';
    primaryBtn.disabled = false;
    primaryBtn.style.opacity = '1';
    secondaryBtn.textContent = 'Gutter —';
    secondaryBtn.className = 'qa-btn qa-miss';
    secondaryBtn.disabled = false;
    secondaryBtn.style.opacity = '1';
    // Spare not valid on attempt 1
    spareBtn.style.opacity = '0.28';
    spareBtn.disabled = true;
  } else {
    // SPARE mode — middle button hidden, primary becomes Spare
    primaryBtn.textContent = 'Spare /';
    primaryBtn.className = 'qa-btn qa-spare';
    primaryBtn.disabled = false;
    primaryBtn.style.opacity = '1';
    secondaryBtn.textContent = 'Miss —';
    secondaryBtn.className = 'qa-btn qa-miss';
    secondaryBtn.disabled = false;
    secondaryBtn.style.opacity = '1';
    spareBtn.style.opacity = '0';
    spareBtn.disabled = true;
  }
}

/* =============================================================
   NAVIGATION — prev/next attempt buttons
   ============================================================= */
function updateNavButtons() {
  const prevBtn = document.getElementById('nav-prev');
  const nextBtn = document.getElementById('nav-next');
  if (!prevBtn || !nextBtn) return;

  // Can we go back?
  const canGoBack = !(G.frame === 1 && G.attempt === 1);
  prevBtn.classList.toggle('disabled', !canGoBack);
  if (canGoBack) prevBtn.removeAttribute('disabled');
  else prevBtn.setAttribute('disabled', '');

  // Can we go forward? — only if current attempt already has data OR we can skip to next recorded
  const nextPos = getNextAttemptPosition(G.frame, G.attempt);
  const canGoForward = nextPos !== null;
  nextBtn.classList.toggle('disabled', !canGoForward);
  if (canGoForward) nextBtn.removeAttribute('disabled');
  else nextBtn.setAttribute('disabled', '');
}

/* Returns the position {frame, attempt} of the next attempt with recorded data,
   or null if at/past the last recorded attempt */
function getNextAttemptPosition(curFrame, curAtt) {
  const allAttempts = getAllAttemptPositions();
  for (const pos of allAttempts) {
    if (pos.frame > curFrame || (pos.frame === curFrame && pos.att > curAtt)) {
      // Check if this position has been recorded
      const fr = getFrame(pos.frame);
      if (!fr) continue;
      const att = frameAttempts(fr.FrameID).find(a=>a.Attempt===pos.att);
      if (att && att.Pinfall !== null) return pos;
      // Also allow navigating to the current live entry position
      if (pos.frame === G.frame && pos.att === G.attempt) return pos;
    }
  }
  return null;
}

function getPrevAttemptPosition(curFrame, curAtt) {
  const allAttempts = getAllAttemptPositions();
  let prev = null;
  for (const pos of allAttempts) {
    if (pos.frame < curFrame || (pos.frame === curFrame && pos.att < curAtt)) {
      prev = pos;
    } else {
      break;
    }
  }
  return prev;
}

/* Build ordered list of all valid attempt positions for this game */
function getAllAttemptPositions() {
  const positions = [];
  for (let fn=1; fn<=10; fn++) {
    const fr = getFrame(fn);
    if (!fr) continue;
    const atts = frameAttempts(fr.FrameID);
    if (fn <= 9) {
      positions.push({frame:fn, att:1});
      // Only include att2 if att1 was not a strike (or if we're reviewing)
      const a1 = atts.find(a=>a.Attempt===1);
      if (!a1 || a1.Pinfall === null || a1.Pinfall < 10) {
        positions.push({frame:fn, att:2});
      }
    } else {
      // Frame 10: always show all 3 slots but gated by scenario
      positions.push({frame:10, att:1});
      positions.push({frame:10, att:2});
      positions.push({frame:10, att:3});
    }
  }
  return positions;
}

function navPrevAttempt() {
  const prev = getPrevAttemptPosition(G.frame, G.attempt);
  if (!prev) return;
  cancelUndo();
  jumpToPosition(prev.frame, prev.att);
}

function navNextAttempt() {
  const next = getNextAttemptPosition(G.frame, G.attempt);
  if (!next) return;
  cancelUndo();
  jumpToPosition(next.frame, next.att);
}

/* Jump to a specific frame (tap on scorecard) — defaults to attempt 1 */
function jumpToFrame(frameNum) {
  if (frameNum === G.frame && G.attempt === 1) return; // Already there
  cancelUndo();
  jumpToPosition(frameNum, 1);
  haptic('light');
}

/* Core jump — navigate to any frame+attempt position */
function jumpToPosition(frameNum, attNum) {
  const fr = getFrame(frameNum);
  if (!fr) return;
  const atts = frameAttempts(fr.FrameID);

  // Guardrail: in frames 1-9, if att1 was a strike, jump to att2 is blocked → redirect to att1
  if (frameNum <= 9 && attNum === 2) {
    const a1 = atts.find(a=>a.Attempt===1);
    if (a1 && a1.Pinfall === 10) {
      attNum = 1; // Can't edit att2 of a strike frame
    }
  }

  // Frame 10 guardrail: don't jump to att3 if att1+att2 don't qualify
  if (frameNum === 10 && attNum === 3) {
    const a1 = atts.find(a=>a.Attempt===1);
    const a2 = atts.find(a=>a.Attempt===2);
    if (!a1 || a1.Pinfall === null || !a2 || a2.Pinfall === null) return;
    const qualifies = a1.Pinfall === 10 || (a1.Pinfall + a2.Pinfall >= 10);
    if (!qualifies) return;
  }

  G.frame = frameNum;
  G.attempt = attNum;

  // Rebuild pin state for this position
  rebuildPinStateForCurrentAttempt();

  // If this attempt already has data, load it for editing
  const targetAtt = atts.find(a=>a.Attempt===attNum);
  if (targetAtt && targetAtt.Pinfall !== null) {
    loadAttemptForEditing(targetAtt, fr);
  } else {
    // Fresh entry position — clear selections
    G.knocked = new Set();
    G.leave = new Set();
  }

  renderScorecard('sc-grid', false);
  updatePinDisplay();
  updatePinfallDisplay();
  updateScoringContext();
}

/* Load a previously-recorded attempt into the editing state */
function loadAttemptForEditing(att, frame) {
  const mode = getAttemptMode();
  G.knocked = new Set();
  G.leave = new Set();

  if (mode === 'LEAVE') {
    // Reconstruct leave set from PinDelta: pins with Delta=0 and Start=1 are the leave
    for (let p=1; p<=10; p++) {
      if (att[`PinStart${p}`] === 1 && att[`PinDelta${p}`] === 0) {
        G.leave.add(p);
      }
    }
    // Derive knocked
    for (let p=1; p<=10; p++) {
      if (G.pinState[p] === 'S' && !G.leave.has(p)) G.knocked.add(p);
    }
  } else {
    // SPARE mode: knocked = pins with Delta=1
    for (let p=1; p<=10; p++) {
      if (att[`PinDelta${p}`] === 1) G.knocked.add(p);
    }
  }
}

/* =============================================================
   PIN DISPLAY UPDATE
   LEAVE mode visual contract:
     B = already down (not applicable on fresh rack — all start as 'S')
     L = pin is STILL STANDING (user tapped it as leave) — gold glow
     (no class / dark) = pin will be KNOCKED (not in leave set) — dark
   SPARE mode visual contract:
     B = was already down before this attempt
     S = still standing (user hasn't knocked it)
     K = user tapped as knocked this attempt — teal glow
   ============================================================= */
function updatePinDisplay() {
  const mode = getAttemptMode();

  for (let p=1;p<=10;p++) {
    const btn = document.getElementById('pb'+p);
    btn.className = 'pin-btn';

    if (G.pinState[p] === 'B') {
      btn.classList.add('B'); // Already down — always inactive
    } else if (mode === 'LEAVE') {
      // LEAVE mode: gold = standing (leave), dark pin = will be knocked
      if (G.leave.has(p)) {
        btn.classList.add('L'); // Still standing — user marked as leave
      }
      // else: no extra class = default dark = "this pin got knocked"
    } else {
      // SPARE mode: teal = knocked this attempt, white = still standing
      if (G.knocked.has(p)) {
        btn.classList.add('K');
      } else {
        btn.classList.add('S');
      }
    }
  }
}

/* Lightweight repaint — only updates the BSK triangle of the current frame.
   Called on every pin toggle for live visual feedback without full re-render. */
function refreshCurrentFrameBSK() {
  const grid = document.getElementById('sc-grid');
  if (!grid) return;
  // Find the current frame's sc-bsk element
  const frameCells = grid.querySelectorAll('.sc-frame');
  const curCell = frameCells[G.frame - 1]; // 0-indexed
  if (!curCell) return;
  const bskEl = curCell.querySelector('.sc-bsk');
  if (!bskEl) return;

  const liveBSK = buildLivePreviewBSK();
  if (!liveBSK) return;

  const isF10 = G.frame === 10;
  if (isF10) {
    // For Frame 10, only update the last triangle (the live one)
    // Keep previously recorded attempt triangles intact
    const fr = getFrame(10);
    const atts = fr ? frameAttempts(fr.FrameID) : [];
    const prevAtts = atts.filter(a => a.BSK_Progressive && a.Pinfall !== null && a.Attempt < G.attempt);
    const tiny = prevAtts.length >= 2;
    let inner = prevAtts.map(a => bskTriangleHTML(a.BSK_Progressive, tiny)).join('');
    inner += bskTriangleHTML(liveBSK, tiny);
    bskEl.innerHTML = inner;
  } else {
    bskEl.innerHTML = bskTriangleHTML(liveBSK, false);
  }
}

function updatePinfallDisplay() {
  const mode = getAttemptMode();
  const pfEl = document.getElementById('pf-num');
  const lblEl = document.getElementById('pf-lbl');

  if (mode === 'LEAVE') {
    // Pinfall = standing pins minus leave pins = knocked count
    const standingCount = Object.values(G.pinState).filter(v=>v==='S').length;
    const pinfall = standingCount - G.leave.size;
    pfEl.textContent = pinfall;
    pfEl.className = 'pf-big leave-mode';
    lblEl.textContent = `Pins Knocked  ·  ${G.leave.size} standing`;
  } else {
    pfEl.textContent = G.knocked.size;
    pfEl.className = 'pf-big spare-mode';
    lblEl.textContent = `Pins Knocked This Attempt`;
  }
}

/* =============================================================
   SCORECARD RENDER — with BSK triangles
   
   BSK display rules per frame (frames 1-9):
   • Strike (Att1 only): show Att1 BSK = KKKKKKKKKK (all K = teal+purple)
   • Frame complete (Att2 done): show Att2 BSK = composite view
       B = knocked in Att1 (dark + purple ring)
       K = knocked in Att2 (teal + purple ring)  
       S = still standing (teal solid)
   • Frame in progress (Att1 done, Att2 not yet):
       Show Att1 BSK = shows B for knocked, S for standing
       This is the "leave" view — what's still standing
   • Current live frame: show live G state preview
   ============================================================= */
function renderScorecard(containerId, isComplete) {
  const grid = document.getElementById(containerId);
  if (!grid) return;
  calculateScores();

  const frames = gameFrames().sort((a,b)=>a.FrameNumber-b.FrameNumber);
  
  const game = db.games.find(g=>g.GameID===G.gameID);
  const showNoTap = (G.scoreDisplay === 'notap') && game?.NoTap;
  if (game?.NoTap) calculateNoTapScores(frames);

  let html = '';

  frames.forEach(fr => {
    const atts = frameAttempts(fr.FrameID);
    const isF10 = fr.FrameNumber === 10;
    const isCur = !isComplete && G.frame === fr.FrameNumber;

    html += `<div class="sc-frame${isCur?' cur':''}"${!isComplete ? ` onclick="jumpToFrame(${fr.FrameNumber})"` : ''}>`;
    html += `<div class="sc-fn">${fr.FrameNumber}</div>`;

    // ── BSK visual ─────────────────────────────────────────────
    if (isF10) {
      // Frame 10: show one BSK triangle per recorded attempt
      const completedAtts = atts.filter(a => a.BSK_Progressive && a.Pinfall !== null);
      html += `<div class="sc-bsk f10">`;
      if (isCur && !isComplete) {
        // Show recorded attempts + live preview of current
        completedAtts.forEach(a => {
          // Only show attempts before the current one
          if (a.Attempt < G.attempt) html += bskTriangleHTML(a.BSK_Progressive, completedAtts.length >= 2);
        });
        // Live preview dot
        const liveBSK = buildLivePreviewBSK();
        if (liveBSK) html += bskTriangleHTML(liveBSK, completedAtts.length >= 2);
      } else if (completedAtts.length) {
        const tiny = completedAtts.length === 3;
        completedAtts.forEach(a => html += bskTriangleHTML(a.BSK_Progressive, tiny));
      } else {
        html += '<div style="height:32px"></div>';
      }
      html += `</div>`;
    } else {
      // Frames 1-9: single triangle, select the right BSK string
      html += `<div class="sc-bsk">`;
      const bskToShow = selectFrameBSK(fr, atts, isCur, isComplete);
      html += bskToShow ? bskTriangleHTML(bskToShow, false) : '<div style="height:32px"></div>';
      html += `</div>`;
    }

    // ── Attempt boxes ───────────────────────────────────────────
    html += `<div class="sc-atts">`;
    if (isF10) {
      const a1=atts.find(a=>a.Attempt===1), a2=atts.find(a=>a.Attempt===2), a3=atts.find(a=>a.Attempt===3);
      if (a1?.Pinfall!=null) html += attBoxHTML(a1, fr, 1, atts, showNoTap);
      if (a2?.Pinfall!=null) html += attBoxHTML(a2, fr, 2, atts, showNoTap);
      if (a3?.Pinfall!=null) html += attBoxHTML(a3, fr, 3, atts, showNoTap);
    } else {
      const a1=atts.find(a=>a.Attempt===1), a2=atts.find(a=>a.Attempt===2);
      if (a1?.Pinfall!=null) html += attBoxHTML(a1, fr, 1, atts, showNoTap);
      if (a2?.Pinfall!=null && !fr.Strike) html += attBoxHTML(a2, fr, 2, atts, showNoTap);
    }
    if (isCur) html += `<div class="att cur">·</div>`;
    html += `</div>`;

    // ── Running total ───────────────────────────────────────────
    const tot = showNoTap ? fr.NoTapRunningTotal : fr.RunningTotal;
    html += `<div class="sc-tot${tot==null?' pend':''}">${tot??'—'}</div>`;
    html += `</div>`;
  });

  grid.innerHTML = html;
}

/* Select the correct BSK string to show for a frame 1-9 cell.
 
   Rules:
   • Strike: Att1 BSK (KKKKKKKKKK — all K, single action)
   • Frame complete (Att2 done): Att2 BSK (composite: B=att1-knocked, K=att2-knocked, S=standing)
   • Frame in progress, Att1 recorded, waiting on Att2: Att1 BSK (shows leave: B=knocked, S=standing)
   • Current live frame: live preview from G state (built on the fly)
   • No data: null (shows empty placeholder)
*/
function selectFrameBSK(fr, atts, isCur, isComplete) {
  const a1 = atts.find(a=>a.Attempt===1);
  const a2 = atts.find(a=>a.Attempt===2);

  if (isCur && !isComplete) {
    // Live frame: show live preview of what user is currently entering
    // Unless we're on Att2 and Att1 is already saved — show live Att2 preview
    return buildLivePreviewBSK();
  }

  if (!a1 || a1.Pinfall === null) return null; // Nothing recorded yet

  if (fr.Strike) {
    // Strike: show Att1 BSK — all K (KKKKKKKKKK)
    return a1.BSK_Progressive;
  }

  if (a2 && a2.Pinfall !== null && a2.BSK_Progressive) {
    // Frame complete: show Att2 BSK = composite frame view
    // Att2 BSK has B where Att1 knocked, K where Att2 knocked, S where still standing
    return a2.BSK_Progressive;
  }

  // Att1 recorded, Att2 not yet: show Att1 BSK (leave view)
  // Att1 BSK has B where knocked (non-strike), S where still standing
  return a1.BSK_Progressive;
}

/* Build a live preview BSK string from current G.pinState + G.leave/G.knocked.
   Uses the same fresh-rack rule as buildBSK():
   - Fresh rack + strike → all K
   - Fresh rack + non-strike → knocked=B, standing=S
   - Spare rack → already-down=B, knocked=K, standing=S */
function buildLivePreviewBSK() {
  const mode = getAttemptMode();
  // Compute knocked set for preview
  let previewKnocked;
  if (mode === 'LEAVE') {
    previewKnocked = new Set();
    for (let p=1; p<=10; p++) {
      if (G.pinState[p] === 'S' && !G.leave.has(p)) previewKnocked.add(p);
    }
  } else {
    previewKnocked = G.knocked;
  }

  // Fresh rack = no pin is in 'B' state
  const isFreshRack = Object.values(G.pinState).every(v => v === 'S');
  const isStrike = isFreshRack && previewKnocked.size === 10;

  let bsk = '';
  for (let p = 1; p <= 10; p++) {
    const start = G.pinState[p];
    const knocked = previewKnocked.has(p);
    if (start === 'B') {
      bsk += 'B';                              // Already down
    } else if (isStrike) {
      bsk += 'K';                              // Strike: all K
    } else if (isFreshRack && knocked) {
      bsk += 'B';                              // Fresh non-strike: knocked → B
    } else if (!knocked) {
      bsk += 'S';                              // Standing
    } else {
      bsk += 'K';                              // Spare rack knocked → K
    }
  }
  return bsk;
}

/* =============================================================
   BSK TRIANGLE HTML
   BSK string: positions 1-10 = pins 1-10
   Display layout:
     Row 1 (back):  7  8  9  10  → indices 6,7,8,9
     Row 2:         4  5  6      → indices 3,4,5
     Row 3:         2  3         → indices 1,2
     Row 4 (front): 1            → index 0
   ============================================================= */
function bskTriangleHTML(bsk, tiny) {
  if (!bsk || bsk.length < 10) return '';
  const p = bsk.split('');
  const d = c => `<div class="dot ${c}"></div>`;
  return `<div class="bsk-tri${tiny?' tiny':''}">
    <div class="bsk-row-m">${d(p[6])}${d(p[7])}${d(p[8])}${d(p[9])}</div>
    <div class="bsk-row-m">${d(p[3])}${d(p[4])}${d(p[5])}</div>
    <div class="bsk-row-m">${d(p[1])}${d(p[2])}</div>
    <div class="bsk-row-m">${d(p[0])}</div>
  </div>`;
}

/* =============================================================
   ATTEMPT BOX HTML
   ============================================================= */
function attBoxHTML(att, frame, attNum, allAtts, showNoTap=false) {
  if (att.Pinfall === null) return '';
  let cls = 'att', disp = att.Pinfall;

  if (frame.FrameNumber <= 9) {
    if (attNum===1 && att.Pinfall===10) { cls+=' X'; disp='X'; }
    else if (attNum===1 && showNoTap && att.Pinfall===9) { cls+=' nt'; disp='9✦'; }
    else if (attNum===2 && frame.Spare)   { cls+=' sp'; disp='/'; }
    else if (att.Pinfall===0)              { cls+=' op'; disp='—'; }
    else                                   { cls+=' op'; }
  } else {
    // Frame 10 — full scenario-aware display
    const a1=allAtts.find(a=>a.Attempt===1);
    const a2=allAtts.find(a=>a.Attempt===2);
    const p1=a1?.Pinfall, p2=a2?.Pinfall;

    if (attNum===1) {
      if (att.Pinfall===10) { cls+=' X'; disp='X'; }
      else if (showNoTap && att.Pinfall===9) { cls+=' nt'; disp='9✦'; }
      else if (att.Pinfall===0) { cls+=' op'; disp='—'; }
      else { cls+=' op'; }
    } else if (attNum===2) {
      if (p1===10) {
        // After a strike — att2 is fresh rack
        if (att.Pinfall===10) { cls+=' X'; disp='X'; }
        else if (showNoTap && att.Pinfall===9) { cls+=' nt'; disp='9✦'; }
        else if (att.Pinfall===0) { cls+=' op'; disp='—'; }
        else { cls+=' op'; }
      } else {
        // Att2 is spare attempt from att1's leave
        if ((p1||0) + att.Pinfall >= 10) { cls+=' sp'; disp='/'; }
        else if (att.Pinfall===0) { cls+=' op'; disp='—'; }
        else { cls+=' op'; }
      }
    } else {
      // Att3
      if (p1===10 && p2===10) {
        // XX_ → att3 is on fresh rack
        if (att.Pinfall===10) { cls+=' X'; disp='X'; }
        else if (showNoTap && att.Pinfall===9) { cls+=' nt'; disp='9✦'; }
        else if (att.Pinfall===0) { cls+=' op'; disp='—'; }
        else { cls+=' op'; }
      } else if (p1===10 && p2!==null && p2!==10) {
        // X#_ → att3 is spare attempt from att2's leave
        if ((p2||0) + att.Pinfall >= 10) { cls+=' sp'; disp='/'; }
        else if (att.Pinfall===0) { cls+=' op'; disp='—'; }
        else { cls+=' op'; }
      } else {
        // #/_ → att3 is on fresh rack
        if (att.Pinfall===10) { cls+=' X'; disp='X'; }
        else if (showNoTap && att.Pinfall===9) { cls+=' nt'; disp='9✦'; }
        else if (att.Pinfall===0) { cls+=' op'; disp='—'; }
        else { cls+=' op'; }
      }
    }
  }
  return `<div class="${cls}">${disp}</div>`;
}

/* =============================================================
   GAME COMPLETE SCREEN
   ============================================================= */
function renderGameComplete() {
  renderScorecard('sc-grid-complete', true);

  const game = db.games.find(g=>g.GameID===G.gameID);
  const score = game?.FinalScore || 0;
  document.getElementById('gc-score').textContent = score;

  // Avg comparison
  const otherScores = db.games.filter(g=>g.FinalScore!=null&&g.GameID!==G.gameID).map(g=>g.FinalScore);
  const diffEl = document.getElementById('gc-diff');
  if (otherScores.length) {
    const avg = Math.round(otherScores.reduce((a,b)=>a+b,0)/otherScores.length);
    const diff = score - avg;
    diffEl.textContent = `${diff>=0?'+':''}${diff} vs avg ${avg}`;
    diffEl.className = 'gc-diff ' + (diff>0?'pos':diff<0?'neg':'neu');
  } else { diffEl.textContent = 'First recorded game!'; diffEl.className='gc-diff neu'; }

  // Stats — computed properly, Frame 10 handled separately
  const frames = gameFrames();
  const frames1to9 = frames.filter(f=>f.FrameNumber<=9);
  const frame10 = frames.find(f=>f.FrameNumber===10);

  const strikes = frames1to9.filter(f=>f.Strike).length;
  const spares  = frames1to9.filter(f=>f.Spare).length;
  const opens   = frames1to9.filter(f=>!f.Strike && !f.Spare).length;
  // Spare rate = spares out of non-strike frames in 1-9
  const spareOpps = frames1to9.filter(f=>!f.Strike).length; // how many spare chances
  const spareRate = spareOpps > 0 ? Math.round((spares / spareOpps) * 100) : 0;

  // Frame 10 result label
  let f10label = '—';
  if (frame10) {
    const f10atts = frameAttempts(frame10.FrameID);
    const f10a1 = f10atts.find(a=>a.Attempt===1);
    const f10a2 = f10atts.find(a=>a.Attempt===2);
    const f10a3 = f10atts.find(a=>a.Attempt===3);
    const p1=f10a1?.Pinfall, p2=f10a2?.Pinfall, p3=f10a3?.Pinfall;
    if (p1===10) f10label = p2===10 ? (p3===10?'Turkey 🦃':'Double+fill') : 'Strike+fill';
    else if (p1!=null && p2!=null && p1+p2>=10) f10label = 'Spare+fill';
    else if (p1!=null && p2!=null) f10label = 'Open';
    else if (p1!=null) f10label = 'In progress';
  }

  document.getElementById('gc-stats').innerHTML = `
    <div class="stat-row"><span>Strikes (F1–9)</span><span class="sval g">${strikes}</span></div>
    <div class="stat-row"><span>Spares (F1–9)</span><span class="sval t">${spares}</span></div>
    <div class="stat-row"><span>Open Frames (F1–9)</span><span class="sval s">${opens}</span></div>
    <div class="stat-row"><span>Spare Rate</span><span class="sval">${spareRate}%</span></div>
    <div class="stat-row"><span>10th Frame</span><span class="sval">${f10label}</span></div>
  `;

  // Next game button
  const league = db.leagues.find(l=>l.LeagueID===G.leagueID);
  const allGames = db.games.filter(g=>g.SeriesID===G.seriesID).sort((a,b)=>a.GameNumber-b.GameNumber);
  const nextGame = allGames.find(g=>g.GameNumber===G.gameNum+1);
  const btn = document.getElementById('btn-next-game');
  if (nextGame && nextGame.FinalScore===null && allGames.length < (league?.GamesPerSeries||3)) {
    btn.style.display='flex';
    btn.textContent = `Start Game ${G.gameNum+1} →`;
  } else if (!nextGame && allGames.length < (league?.GamesPerSeries||3)) {
    btn.style.display='flex';
    btn.textContent = `Start Game ${G.gameNum+1} →`;
  } else {
    btn.style.display='none';
  }
}

function goNextGame() {
  const allGames = db.games.filter(g=>g.SeriesID===G.seriesID).sort((a,b)=>a.GameNumber-b.GameNumber);
  const nextGame = allGames.find(g=>g.GameNumber===G.gameNum+1);
  if (nextGame) {
    openGame(nextGame.GameID, nextGame.GameNumber);
  } else {
    createAndStartGame(); // Will auto-go to scoring
  }
}

function endSeries() {
  G.gameID = null;
  navTo('s-series');
}

/* =============================================================
   STATS
   ============================================================= */
function renderStats() {
  /* ── Raw data pools ──────────────────────────────────────── */
  const allGames  = db.games.filter(g => g.FinalScore != null);
  const scores    = allGames.map(g => g.FinalScore);
  const gameIDs   = new Set(allGames.map(g => g.GameID));

  /* ── Game Statistics ─────────────────────────────────────── */
  const gameCount = scores.length;
  const avg       = gameCount ? (scores.reduce((a,b)=>a+b,0) / gameCount).toFixed(1) : '—';
  const high      = gameCount ? Math.max(...scores) : '—';
  const totalPins = gameCount ? scores.reduce((a,b)=>a+b,0) : 0;

  // Clean game = every frame (1-10) is Strike or Spare — zero opens anywhere
  const cleanGames = allGames.filter(g => {
    const gFrames = db.frames.filter(f => f.GameID === g.GameID);
    return gFrames.length > 0 && gFrames.every(f => f.Strike || f.Spare);
  }).length;

  /* ── Frame pool: 1-9 plus qualifying Frame 10 attempts ────── */
  // Frames 1-9: always included as normal scoring frames.
  // Frame 10: include att1 (always a first-ball delivery) and att2 IF att1 was not a strike
  //   (i.e. att2 is a true spare-conversion attempt, not a fill shot after a strike).
  //   Att3 is ALWAYS excluded — it is a fill shot regardless of scenario.
  //
  // Specifically we add Frame 10 as a "virtual frame" when:
  //   A) att1 is a strike (count strike, then att2 is fill — skip att2/att3)
  //   B) att1 + att2 < 10 → open (count as open frame)
  //   C) att1 + att2 >= 10 AND att1 < 10 → spare (count as spare opp + conversion)
  //
  // For strike/spare/open counts we synthesize Frame 10 data from attempts directly.

  // Frames 1-9 base pool
  const frames19  = db.frames.filter(f => f.FrameNumber <= 9 && gameIDs.has(f.GameID));
  const frameIDs9 = new Set(frames19.map(f => f.FrameID));

  // Strike / spare / open tallies for frames 1-9
  let strikeFr = frames19.filter(f => f.Strike).length;
  let spareFr  = frames19.filter(f => f.Spare).length;
  let openFr   = frames19.filter(f => !f.Strike && !f.Spare).length;
  let totalFr  = frames19.length;
  let spareOpps = frames19.filter(f => !f.Strike).length; // non-strike frames = spare opportunities

  // Frame 10 contributions — built from raw attempts (att3 excluded)
  const f10Frames = db.frames.filter(f => f.FrameNumber === 10 && gameIDs.has(f.GameID));
  f10Frames.forEach(f10 => {
    const a1 = db.attempts.find(a => a.FrameID === f10.FrameID && a.Attempt === 1);
    const a2 = db.attempts.find(a => a.FrameID === f10.FrameID && a.Attempt === 2);
    if (!a1 || a1.Pinfall === null) return;

    totalFr++; // Frame 10 always counts as one frame delivery

    if (a1.Pinfall === 10) {
      // Att1 strike in F10 → count as strike; att2/att3 are fill shots, excluded
      strikeFr++;
    } else {
      // Att1 was not a strike → att2 is a true spare attempt
      spareOpps++;
      if (a2 && a2.Pinfall !== null) {
        const twoball = a1.Pinfall + a2.Pinfall;
        if (twoball >= 10) {
          spareFr++;  // converted the spare
        } else {
          openFr++;   // open in frame 10
        }
      }
    }
  });

  const sPct  = totalFr   ? ((strikeFr / totalFr)   * 100).toFixed(1) : '0.0';
  const spPct = spareOpps ? ((spareFr  / spareOpps)  * 100).toFixed(1) : '0.0';

  /* ── First Ball Average ──────────────────────────────────── */
  // Att1 Pinfall for frames 1-9 + att1 of frame 10 (always a first-ball delivery).
  // Uses Pinfall directly — equals pins knocked on that ball.
  const att1F9   = db.attempts.filter(a =>
    a.FrameNumber <= 9 && a.Attempt === 1 && frameIDs9.has(a.FrameID) && a.Pinfall !== null
  );
  const f10FrameIDs = new Set(f10Frames.map(f => f.FrameID));
  const att1F10  = db.attempts.filter(a =>
    a.Attempt === 1 && f10FrameIDs.has(a.FrameID) && a.Pinfall !== null
  );
  const allAtt1  = [...att1F9, ...att1F10];
  const firstBallAvg = allAtt1.length
    ? (allAtt1.reduce((s,a) => s + (a.Pinfall||0), 0) / allAtt1.length).toFixed(2)
    : '—';

  /* ── Split Detection — ported from modSplitDetection v3.0 ── */
  // Vertical adjacency ONLY (no horizontal-only connections within same row).
  // Uses flood-fill cluster counting: a leave is a split when pin 1 is down,
  // 2+ pins remain, and those pins form more than one disconnected cluster.
  //
  // Adjacency map (vertical/diagonal connections only, per VBA source):
  //   Pin 1: 2,3,5         Pin 2: 1,4,5,8       Pin 3: 1,5,6,9
  //   Pin 4: 2,7,8         Pin 5: 1,2,3,8,9      Pin 6: 3,9,10
  //   Pin 7: 4             Pin 8: 2,4,5           Pin 9: 3,5,6
  //   Pin 10: 6
  // NOTE: Same-row pins (2-3, 4-5, 4-6, 5-6, 7-8, 7-9, 8-9, 8-10, 9-10)
  //       are NOT adjacent — horizontal contact alone doesn't bridge a split.
  const VERT_ADJ = {
    1:[2,3,5], 2:[1,4,5,8], 3:[1,5,6,9],
    4:[2,7,8], 5:[1,2,3,8,9], 6:[3,9,10],
    7:[4],     8:[2,4,5],      9:[3,5,6],
    10:[6]
  };

  function floodFill(pin, pins, visited) {
    visited[pin] = true;
    (VERT_ADJ[pin] || []).forEach(adj => {
      if (pins[adj] && !visited[adj]) floodFill(adj, pins, visited);
    });
  }

  function countClusters(pins) {
    // pins is object {2:bool .. 10:bool}
    const visited = {};
    let clusters = 0;
    for (let p = 2; p <= 10; p++) {
      if (pins[p] && !visited[p]) { floodFill(p, pins, visited); clusters++; }
    }
    return clusters;
  }

  function isSplit(leave) {
    // leave = Set of standing pin numbers
    if (leave.has(1)) return false;  // headpin up → not a split
    if (leave.size < 2) return false; // need 2+ pins
    const pins = {};
    leave.forEach(p => { pins[p] = true; });
    return countClusters(pins) > 1;
  }

  // Helper: get standing pins after att1 using PinStart/PinDelta fields
  function getLeave(a1) {
    const standing = new Set();
    for (let p = 1; p <= 10; p++) {
      if (a1[`PinStart${p}`] === 1 && a1[`PinDelta${p}`] !== 1) standing.add(p);
    }
    return standing;
  }

  /* ── Spare breakdown (frames 1-9, non-strike frames only) ── */
  // Frame 10 is excluded from spare breakdown — the second delivery in F10
  // after a non-strike is a spare attempt, but split/single/multi categorization
  // of F10 leaves is atypical and would skew the breakdown.
  let makeableOpp = 0, makeableConv = 0;
  let singleOpp   = 0, singleConv   = 0;
  let multiOpp    = 0, multiConv    = 0;
  let splitOpp    = 0, splitConv    = 0;
  let hasPinData  = false;

  frames19.filter(f => !f.Strike).forEach(frame => {
    const a1 = db.attempts.find(a => a.FrameID === frame.FrameID && a.Attempt === 1);
    if (!a1 || a1.Pinfall === null) return;
    if (a1.Pinfall === 10) return; // shouldn't happen (frame.Strike filtered), but guard

    // Pin-level data check: if PinDelta fields are populated we can classify the leave
    const pinDataOk = [1,2,3,4,5,6,7,8,9,10].some(p => a1[`PinDelta${p}`] !== null);
    if (pinDataOk) hasPinData = true;

    const leave    = getLeave(a1);
    const converted = frame.Spare;

    if (leave.size === 0) return; // shouldn't happen after non-strike filter

    const isS     = isSplit(leave);
    const isSingle = leave.size === 1;

    if (isS) {
      splitOpp++;   if (converted) splitConv++;
    } else {
      makeableOpp++; if (converted) makeableConv++;
      if (isSingle) { singleOpp++; if (converted) singleConv++; }
      else          { multiOpp++;  if (converted) multiConv++;  }
    }
  });

  const mkPct  = makeableOpp ? Math.round(makeableConv / makeableOpp * 100) : '—';
  const spgPct = singleOpp   ? Math.round(singleConv  / singleOpp  * 100) : '—';
  const mpPct  = multiOpp    ? Math.round(multiConv   / multiOpp   * 100) : '—';
  const slPct  = splitOpp    ? Math.round(splitConv   / splitOpp   * 100) : '—';

  /* ── Render ──────────────────────────────────────────────── */
  const pct = (n, tot) => tot ? `${Math.round(n/tot*100)}% (${n}/${tot})` : '—';
  const noData = `<div style="padding:24px;text-align:center;color:var(--t3);font-size:13px">No games recorded yet</div>`;

  if (!gameCount) { document.getElementById('stats-content').innerHTML = noData; return; }

  document.getElementById('stats-content').innerHTML = `

    <!-- ── Top 3 cards ── -->
    <div class="stat-card">
      <div class="stat-card-title">Average</div>
      <div class="stat-card-val" style="color:var(--teal)">${avg}</div>
      <div class="stat-card-sub">${gameCount} game${gameCount===1?'':'s'} recorded</div>
    </div>
    <div class="stat-card" style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div>
        <div class="stat-card-title">High Game</div>
        <div class="stat-card-val" style="color:var(--gold);font-size:30px">${high}</div>
      </div>
      <div>
        <div class="stat-card-title">Low Game</div>
        <div class="stat-card-val" style="color:var(--sedona);font-size:30px">${scores.length ? Math.min(...scores) : '—'}</div>
      </div>
    </div>

    <!-- ── Game Statistics ── -->
    <div style="height:8px"></div>
    <div style="font-size:11px;font-weight:700;color:var(--t3);letter-spacing:1px;text-transform:uppercase;padding:0 2px;margin-bottom:6px">Game Statistics</div>
    <div class="stat-card" style="padding:12px 14px">
      <div class="stat-row" style="border:none;padding:4px 0">
        <span>Games Bowled</span><span class="sval t">${gameCount}</span></div>
      <div class="stat-row" style="padding:4px 0">
        <span>Clean Games</span>
        <span class="sval g">${cleanGames}${gameCount?' / '+gameCount:''}</span></div>
      <div class="stat-row" style="padding:4px 0">
        <span>Total Pins</span>
        <span class="sval" style="color:var(--gold)">${totalPins.toLocaleString()}</span></div>
    </div>

    <!-- ── Frame Statistics ── -->
    <div style="height:4px"></div>
    <div style="font-size:11px;font-weight:700;color:var(--t3);letter-spacing:1px;text-transform:uppercase;padding:0 2px;margin-bottom:6px">Frame Statistics</div>
    <div class="stat-card" style="padding:12px 14px">
      <div class="stat-row" style="border:none;padding:4px 0">
        <span>First Ball Average</span>
        <span class="sval t">${firstBallAvg}</span></div>
      <div class="stat-row" style="padding:4px 0">
        <span>Strikes</span>
        <span class="sval g">${pct(strikeFr, totalFr)}</span></div>
      <div class="stat-row" style="padding:4px 0">
        <span>Spares</span>
        <span class="sval t">${pct(spareFr, spareOpps)}</span></div>
      <div class="stat-row" style="padding:6px 0 4px;padding-left:14px;border-top:1px solid var(--border1);margin-top:4px">
        <span style="color:var(--t2)">Makeable</span>
        <span class="sval t">${makeableOpp ? mkPct+'% ('+makeableConv+'/'+makeableOpp+')' : '—'}</span></div>
      <div class="stat-row" style="padding:4px 0 4px;padding-left:28px">
        <span style="color:var(--t3);font-size:13px">Single Pin</span>
        <span class="sval" style="color:var(--t2);font-size:13px">${singleOpp ? spgPct+'% ('+singleConv+'/'+singleOpp+')' : '—'}</span></div>
      <div class="stat-row" style="padding:4px 0 4px;padding-left:28px">
        <span style="color:var(--t3);font-size:13px">Multiple Pins</span>
        <span class="sval" style="color:var(--t2);font-size:13px">${multiOpp ? mpPct+'% ('+multiConv+'/'+multiOpp+')' : '—'}</span></div>
      <div class="stat-row" style="padding:4px 0 4px;padding-left:14px">
        <span style="color:var(--sedona)">Splits</span>
        <span class="sval" style="color:var(--sedona)">${splitOpp ? slPct+'% ('+splitConv+'/'+splitOpp+')' : '—'}</span></div>
      <div class="stat-row" style="padding:6px 0 2px;margin-top:4px;border-top:1px solid var(--border1)">
        <span>Opens</span>
        <span class="sval s">${openFr > 0 ? openFr+' ('+Math.round(openFr/totalFr*100)+'%)' : '0'}</span></div>
    </div>

    ${!hasPinData && spareOpps > 0 ? `<div style="font-size:11px;color:var(--t3);padding:6px 4px;line-height:1.5">
      ⓘ Spare breakdown requires per-pin tracking. Older games recorded before pin data was available will show — for subcategories.</div>` : ''}
  `;
}

/* =============================================================
   UNDO SYSTEM
   ============================================================= */
function showUndoBar(frame, att) {
  G.undoAvailable = true;
  const bar = document.getElementById('undo-bar');
  const label = document.getElementById('undo-txt');
  const countdown = document.getElementById('undo-countdown');
  const what = att.Pinfall===10 ? 'Strike!' : att.Pinfall===0 ? 'Miss' : `${att.Pinfall} pins`;
  label.textContent = `Frame ${frame.FrameNumber} Att ${att.Attempt} · ${what}`;
  bar.classList.add('show');

  let secs = 4;
  countdown.textContent = secs;
  G.undoTick = setInterval(()=>{
    secs--;
    countdown.textContent = secs;
    if (secs<=0) cancelUndo();
  }, 1000);
  G.undoTimer = setTimeout(()=> cancelUndo(), 4500);
}

function cancelUndo() {
  G.undoAvailable = false;
  clearTimeout(G.undoTimer);
  clearInterval(G.undoTick);
  document.getElementById('undo-bar').classList.remove('show');
}

function doUndo() {
  if (!G.undoSnapshot) return;
  const snap = JSON.parse(G.undoSnapshot);
  db = snap.db;
  G.frame = snap.G_frame;
  G.attempt = snap.G_attempt;
  G.pinState = snap.G_pinState;
  G.knocked = new Set(snap.G_knocked);
  G.leave = new Set(snap.G_leave || []);
  G.undoSnapshot = null;
  cancelUndo();
  saveDB();
  renderScorecard('sc-grid', false);
  updatePinDisplay();
  updatePinfallDisplay();
  updateScoringContext();
  toast('Undone ↩');
  haptic('light');
}

/* =============================================================
   OPEN BOWLING — separate flow, own session table
   ============================================================= */
function renderOpenList() {
  const el = document.getElementById('open-list');
  if (!el) return;
  const sessions = (db.openSessions||[]).sort((a,b)=>new Date(b.DateBowled)-new Date(a.DateBowled));
  if (!sessions.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">🎳</div>
      <div class="empty-label">No open sessions yet</div>
      <div class="empty-sub">Tap + to start bowling</div></div>`;
    return;
  }
  el.innerHTML = sessions.map(s => {
    const center = db.centers.find(c=>c.CenterID===s.CenterID);
    const games = db.games.filter(g=>g.SeriesID===s.SessionID);
    const scores = games.map(g=>g.FinalScore).filter(x=>x!=null);
    const total = scores.reduce((a,b)=>a+b,0);
    const d = new Date(s.DateBowled).toLocaleDateString('en-US',{month:'numeric',day:'numeric',year:'2-digit'});
    const badges = games.map(g=>g.FinalScore!=null
      ? `<div class="game-badge done">${g.FinalScore}</div>`
      : `<div class="game-badge empty">—</div>`).join('');
    return `<div class="open-session-card" onclick="selectOpenSession(${s.SessionID})">
      <div class="open-session-hdr">
        <div>
          <div class="open-session-date">${d}</div>
          <div class="open-session-center">${center?.CenterName||'—'} · Lane ${s.Lane||'?'}</div>
        </div>
        <div class="open-session-total">${total||'...'}</div>
      </div>
      <div class="open-session-games">${badges}</div>
    </div>`;
  }).join('');
}

function openNewOpenSessionModal() {
  const today = new Date().toISOString().split('T')[0];
  const cOpts = db.centers.map(c=>`<option value="${c.CenterID}">${c.CenterName}</option>`).join('');
  const bOpts = db.balls.map(b=>`<option value="${b.BallID}">${b.BallName}</option>`).join('');
  openModal(`
    <div class="modal-title">New Open Session</div>
    <div class="fgroup"><label class="flabel">Date</label>
      <input class="finput" id="ob-date" type="date" value="${today}"></div>
    <div class="fgroup"><label class="flabel">Center</label>
      <select class="finput" id="ob-center">${cOpts}</select></div>
    <div class="fgroup"><label class="flabel">Lane</label>
      <input class="finput" id="ob-lane" type="number" min="1" max="99" placeholder="e.g. 12"></div>
    <div class="fgroup"><label class="flabel">Alternating Lanes?</label>
      <div class="odd-even-toggle">
        <div class="oe-btn on" id="ob-single" onclick="setOpenLaneMode('single')">Single Lane</div>
        <div class="oe-btn" id="ob-pair" onclick="setOpenLaneMode('pair')">Lane Pair</div>
      </div>
    </div>
    <div id="ob-pair-section" style="display:none">
      <div class="fgroup"><label class="flabel">Second Lane</label>
        <input class="finput" id="ob-lane2" type="number" min="1" max="99" placeholder="e.g. 13"></div>
    </div>
    <div class="fgroup"><label class="flabel">Number of Games</label>
      <select class="finput" id="ob-games">
        ${[1,2,3,4,5,6].map(n=>`<option value="${n}"${n===3?' selected':''}>${n}</option>`).join('')}
      </select></div>
    <div class="fgroup"><label class="flabel">Ball</label>
      <select class="finput" id="ob-ball">${bOpts}</select></div>
    <div class="fgroup"><label class="flabel">Notes</label>
      <input class="finput" id="ob-notes" type="text" placeholder="Optional"></div>
    <button class="btn btn-primary" onclick="saveOpenSession()">Start Bowling →</button>
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
  `);
}

function setOpenLaneMode(mode) {
  document.getElementById('ob-single').classList.toggle('on', mode==='single');
  document.getElementById('ob-pair').classList.toggle('on', mode==='pair');
  document.getElementById('ob-pair-section').style.display = mode==='pair' ? 'block' : 'none';
}

function saveOpenSession() {
  const date = document.getElementById('ob-date').value;
  const centerID = parseInt(document.getElementById('ob-center').value);
  const lane = parseInt(document.getElementById('ob-lane').value)||null;
  const isPair = document.getElementById('ob-pair').classList.contains('on');
  const lane2 = isPair ? (parseInt(document.getElementById('ob-lane2')?.value)||null) : null;
  const numGames = parseInt(document.getElementById('ob-games').value)||3;
  const ballID = parseInt(document.getElementById('ob-ball').value);
  const notes = document.getElementById('ob-notes').value.trim();
  const lanePair = isPair && lane && lane2 ? `${Math.min(lane,lane2)}-${Math.max(lane,lane2)}` : null;

  const sessionID = db.ids.openSession++;
  if (!db.openSessions) db.openSessions = [];
  db.openSessions.push({ SessionID:sessionID, DateBowled:date, CenterID:centerID,
    Lane:lane, LanePair:lanePair, NumGames:numGames, BallID:ballID, Notes:notes });

  // Open sessions reuse the series ID space but are tagged separately
  // Use a fake LeagueID=0 to mark open bowling games; keep SeriesID = SessionID
  G.leagueID = 0;
  G.seriesID = sessionID;
  G.ballID = ballID;
  G.laneStart = lane;
  G.lanePair = lanePair||`${lane}`;

  // Create a matching series record so createAndStartGame() works
  db.series.push({ SeriesID:sessionID, LeagueID:0, CenterID:centerID,
    DateBowled:date, LanePair:lanePair||`${lane}`, LaneStart:lane,
    BallID:ballID, Notes:notes, GameType:'Open', GamesPerSeries:numGames });

  saveDB(); closeModal();
  createAndStartGame();
}

function selectOpenSession(id) {
  const s = db.openSessions?.find(x=>x.SessionID===id);
  if (!s) return;
  G.leagueID = 0;
  G.seriesID = id;
  navTo('s-game-select');
}

/* =============================================================
   TOURNAMENTS
   ============================================================= */
function renderTournamentList() {
  const el = document.getElementById('tournament-list');
  if (!el) return;
  const tours = db.tournaments||[];
  if (!tours.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">🏅</div>
      <div class="empty-label">No tournaments yet</div>
      <div class="empty-sub">Tap + to add a tournament</div></div>`;
    return;
  }
  el.innerHTML = tours.map(t => {
    const center = db.centers.find(c=>c.CenterID===t.CenterID);
    const d = t.DateStart ? new Date(t.DateStart).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '—';
    return `<div class="list-row" onclick="selectTournament(${t.TournamentID})">
      <div class="list-row-body">
        <div class="list-row-name">${t.TournamentName}</div>
        <div class="list-row-meta">${center?.CenterName||'—'} · ${d}</div>
      </div>
      <span class="list-row-chevron">›</span>
    </div>`;
  }).join('');
}

function openNewTournamentModal() {
  const today = new Date().toISOString().split('T')[0];
  const cOpts = db.centers.map(c=>`<option value="${c.CenterID}">${c.CenterName}</option>`).join('');
  openModal(`
    <div class="modal-title">New Tournament</div>
    <div class="fgroup"><label class="flabel">Tournament Name</label>
      <input class="finput" id="nt-name" placeholder="e.g. City Championship 2026" type="text" autocomplete="off"></div>
    <div class="fgroup"><label class="flabel">Center</label>
      <select class="finput" id="nt-center">${cOpts}</select></div>
    <div class="fgroup"><label class="flabel">Date</label>
      <input class="finput" id="nt-date" type="date" value="${today}"></div>
    <div class="fgroup"><label class="flabel">Games Per Round</label>
      <select class="finput" id="nt-gps">
        ${[2,3,4,5,6,8].map(n=>`<option value="${n}"${n===6?' selected':''}>${n}</option>`).join('')}
      </select></div>
    <div class="fgroup"><label class="flabel">Notes</label>
      <input class="finput" id="nt-notes" type="text" placeholder="Optional"></div>
    <button class="btn btn-primary" onclick="saveNewTournament()">Create Tournament</button>
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
  `);
  setTimeout(()=>document.getElementById('nt-name')?.focus(), 350);
}

function saveNewTournament() {
  const name = document.getElementById('nt-name').value.trim();
  if (!name) { toast('Enter a tournament name'); return; }
  const centerID = parseInt(document.getElementById('nt-center').value);
  const date = document.getElementById('nt-date').value;
  const gps = parseInt(document.getElementById('nt-gps').value)||6;
  const notes = document.getElementById('nt-notes').value.trim();
  const id = db.ids.tournament++;
  if (!db.tournaments) db.tournaments = [];
  db.tournaments.push({ TournamentID:id, TournamentName:name, CenterID:centerID,
    DateStart:date, GamesPerRound:gps, Notes:notes, Archived:false });
  saveDB(); closeModal(); renderTournamentList(); toast('Tournament created!');
}

function selectTournament(id) {
  // Tournaments share the league+series flow; set leagueID to negative to distinguish
  toast('Tournament scoring — coming soon');
}

/* =============================================================
   MODALS
   ============================================================= */
function openModal(html) {
  document.getElementById('modal-body').innerHTML = html;
  document.getElementById('modal-bg').classList.add('open');
}
function closeModal() { document.getElementById('modal-bg').classList.remove('open'); }
function handleModalBgClick(e) { if (e.target===document.getElementById('modal-bg')) closeModal(); }

function openNewLeagueModal() { openLeagueModal(null); }
function openEditLeagueModal(id) { openLeagueModal(id); }

function openLeagueModal(id) {
  const l = id ? db.leagues.find(x=>x.LeagueID===id) : null;
  const isEdit = !!l;
  const cOpts = db.centers.map(c=>`<option value="${c.CenterID}"${l?.CenterID===c.CenterID?' selected':''}>${c.CenterName}</option>`).join('');
  const bOpts = `<option value="">— None —</option>` + db.balls.map(b=>`<option value="${b.BallID}"${l?.DefaultBallID===b.BallID?' selected':''}>${b.BallName}</option>`).join('');
  const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  const dayOpts = `<option value="">— Any —</option>` + days.map(d=>`<option${l?.DayOfBowling===d?' selected':''}>${d}</option>`).join('');
  const gpsOpts = [2,3,4,5,6].map(n=>`<option value="${n}"${(l?.GamesPerSeries||3)===n?' selected':''}>${n}</option>`).join('');

  openModal(`
    <div class="modal-title">${isEdit?'Edit League':'New League'}</div>
    <div class="fgroup"><label class="flabel">League Name</label>
      <input class="finput" id="ml-name" placeholder="e.g. NFL 25/26" type="text" autocomplete="off" value="${l?.LeagueName||''}"></div>
    <div class="fgroup"><label class="flabel">Bowling Center</label>
      <select class="finput" id="ml-center">${cOpts}</select></div>
    <div class="fgroup"><label class="flabel">Games Per Series</label>
      <select class="finput" id="ml-gps">${gpsOpts}</select></div>
    <div class="fgroup"><label class="flabel">Day of Week</label>
      <select class="finput" id="ml-day">${dayOpts}</select></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="fgroup"><label class="flabel">League Length (weeks)</label>
        <input class="finput" id="ml-weeks" type="number" min="0" max="52" value="${l?.Weeks||0}" placeholder="e.g. 36"></div>
      <div class="fgroup"><label class="flabel">Weekly Dues ($)</label>
        <input class="finput" id="ml-dues" type="number" min="0" step="0.01" value="${l?.WeeklyDues||0}" placeholder="0.00"></div>
    </div>
    <div class="fgroup"><label class="flabel">Default Ball</label>
      <select class="finput" id="ml-ball">${bOpts}</select></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 4px">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input type="checkbox" id="ml-handicap" style="width:16px;height:16px;accent-color:var(--teal)" ${l?.Handicap?'checked':''}>
        <span class="flabel" style="margin:0">Handicap League</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input type="checkbox" id="ml-sport" style="width:16px;height:16px;accent-color:var(--purple)" ${l?.Sport?'checked':''}>
        <span class="flabel" style="margin:0">Sport Bowling</span>
      </label>
    </div>
    <div class="fgroup"><label class="flabel">Notes</label>
      <input class="finput" id="ml-notes" type="text" placeholder="Optional notes" value="${l?.Notes||''}"></div>
    <button class="btn btn-primary" onclick="saveLeague(${id||'null'})">${isEdit?'Save Changes':'Create League'}</button>
    ${isEdit?'':'<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>'}
    ${isEdit?`<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>`:''}
  `);
  setTimeout(()=>document.getElementById('ml-name')?.focus(), 350);
}

function saveLeague(id) {
  const name = document.getElementById('ml-name').value.trim();
  if (!name) { toast('Enter a league name'); return; }
  const cid = parseInt(document.getElementById('ml-center').value);
  const gps = parseInt(document.getElementById('ml-gps').value);
  const day = document.getElementById('ml-day').value;
  const weeks = parseInt(document.getElementById('ml-weeks').value)||0;
  const dues = parseFloat(document.getElementById('ml-dues').value)||0;
  const ballRaw = document.getElementById('ml-ball').value;
  const ballID = ballRaw ? parseInt(ballRaw) : null;
  const notes = document.getElementById('ml-notes').value.trim();
  const handicap = document.getElementById('ml-handicap').checked;
  const sport = document.getElementById('ml-sport').checked;

  if (id) {
    const l = db.leagues.find(x=>x.LeagueID===id);
    if (l) { l.LeagueName=name; l.CenterID=cid; l.GamesPerSeries=gps; l.DayOfBowling=day;
      l.Weeks=weeks; l.WeeklyDues=dues; l.DefaultBallID=ballID; l.Notes=notes;
      l.Handicap=handicap; l.Sport=sport; }
    saveDB(); closeModal(); renderLeagues(); toast('League updated!');
  } else {
    const newId = db.ids.league++;
    db.leagues.push({ LeagueID:newId, LeagueName:name, CenterID:cid, GamesPerSeries:gps,
      DayOfBowling:day, Weeks:weeks, WeeklyDues:dues, DefaultBallID:ballID, Notes:notes,
      Active:true, Handicap:handicap, Sport:sport, Archived:false });
    saveDB(); closeModal(); renderLeagues(); toast('League created!');
  }
}

function openNewSeriesModal() { openSeriesModal(null); }
function openEditSeriesModal(id) { openSeriesModal(id); }

function openSeriesModal(id) {
  const s = id ? db.series.find(x=>x.SeriesID===id) : null;
  const isEdit = !!s;
  const today = new Date().toISOString().split('T')[0];
  const bOpts = db.balls.map(b=>`<option value="${b.BallID}"${s?.BallID===b.BallID||(!s&&b.BallID===db.leagues.find(l=>l.LeagueID===G.leagueID)?.DefaultBallID)?' selected':''}>${b.BallName}</option>`).join('');
  const cOpts = db.centers.map(c=>`<option value="${c.CenterID}"${(s?.CenterID||db.leagues.find(l=>l.LeagueID===G.leagueID)?.CenterID)===c.CenterID?' selected':''}>${c.CenterName}</option>`).join('');
  const lOpts = db.leagues.filter(l=>!l.Archived).map(l=>`<option value="${l.LeagueID}"${(s?.LeagueID||G.leagueID)===l.LeagueID?' selected':''}>${l.LeagueName}</option>`).join('');

  const laneSection = isEdit ? `
    <div class="fgroup"><label class="flabel">Lane Pair</label>
      <input class="finput" id="ms-lanepair" type="text" placeholder="e.g. 15-16" value="${s?.LanePair||''}"></div>` : `
    <div class="fgroup"><label class="flabel">Lane Pair</label>
      <div class="lane-pair-row">
        <input class="lane-num-input" id="ms-lane-odd" type="number" min="1" max="99" value="15" oninput="updateLanePreview()">
        <div class="lane-sep">–</div>
        <input class="lane-num-input" id="ms-lane-even" type="number" min="2" max="100" value="16" oninput="updateLanePreview()">
      </div>
      <div class="odd-even-toggle">
        <div class="oe-btn on" id="oe-odd" onclick="setStartLane('odd')">Start Odd Lane</div>
        <div class="oe-btn" id="oe-even" onclick="setStartLane('even')">Start Even Lane</div>
      </div>
      <div class="lane-preview" id="lane-preview">Game 1: Lane 15 · Game 2: Lane 16 · Game 3: Lane 15</div>
    </div>`;

  openModal(`
    <div class="modal-title">${isEdit?'Edit Series':'New Series'}</div>
    <div class="fgroup"><label class="flabel">Date</label>
      <input class="finput" id="ms-date" type="date" value="${s?.DateBowled||today}"></div>
    <div class="fgroup"><label class="flabel">League</label>
      <select class="finput" id="ms-league">${lOpts}</select></div>
    <div class="fgroup"><label class="flabel">Center</label>
      <select class="finput" id="ms-center">${cOpts}</select></div>
    <div class="fgroup"><label class="flabel">Primary Ball</label>
      <select class="finput" id="ms-ball">${bOpts}</select></div>
    ${laneSection}
    <div class="fgroup"><label class="flabel">Notes</label>
      <input class="finput" id="ms-notes" type="text" placeholder="Optional notes" value="${s?.Notes||''}"></div>
    <button class="btn btn-primary" onclick="saveSeries(${id||'null'})">${isEdit?'Save Changes':'Start Bowling →'}</button>
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
  `);
  setTimeout(()=>{ document.getElementById('ms-date')?.focus(); if (!isEdit) updateLanePreview(); }, 350);
}

/* Lane preview helpers — used by new-series and new-open-session modals */
function updateLanePreview() {
  const oddEl  = document.getElementById('ms-lane-odd')  || document.getElementById('ob-lane-odd');
  const evenEl = document.getElementById('ms-lane-even') || document.getElementById('ob-lane-even');
  const previewEl = document.getElementById('lane-preview') || document.getElementById('ob-lane-preview');
  if (!oddEl || !previewEl) return;

  const odd  = parseInt(oddEl.value)  || 15;
  const even = evenEl ? (parseInt(evenEl.value) || odd+1) : null;

  // Single-lane mode (open bowling) — no alternation
  if (!even) {
    previewEl.textContent = `All games: Lane ${odd}`;
    return;
  }

  const lo = Math.min(odd, even), hi = Math.max(odd, even);
  const startOdd = document.getElementById('oe-odd')?.classList.contains('on') ?? true;
  const startLane = startOdd ? lo : hi;
  const altLane   = startOdd ? hi : lo;
  const gps = parseInt(document.getElementById('ml-gps')?.value) || 3;
  const parts = [];
  for (let i = 1; i <= Math.min(gps, 5); i++) {
    parts.push(`G${i}: Ln ${i % 2 === 1 ? startLane : altLane}`);
  }
  previewEl.textContent = parts.join(' · ');
}

function setStartLane(which) {
  document.getElementById('oe-odd')?.classList.toggle('on',  which === 'odd');
  document.getElementById('oe-even')?.classList.toggle('on', which === 'even');
  updateLanePreview();
}


function saveSeries(id) {
  const date = document.getElementById('ms-date').value;
  const leagueID = parseInt(document.getElementById('ms-league').value);
  const centerID = parseInt(document.getElementById('ms-center').value);
  const ballID = parseInt(document.getElementById('ms-ball').value);
  const notes = document.getElementById('ms-notes').value.trim();
  G.ballID = ballID;

  if (id) {
    const s = db.series.find(x=>x.SeriesID===id);
    if (s) {
      s.DateBowled = date; s.LeagueID = leagueID; s.CenterID = centerID;
      s.BallID = ballID; s.Notes = notes;
      const lp = document.getElementById('ms-lanepair');
      if (lp) { s.LanePair = lp.value.trim() || s.LanePair; }
    }
    saveDB(); closeModal(); renderSeriesList(); toast('Series updated!');
  } else {
    const oddLane = parseInt(document.getElementById('ms-lane-odd')?.value)||15;
    const evenLane = parseInt(document.getElementById('ms-lane-even')?.value)||(oddLane+1);
    const startOdd = document.getElementById('oe-odd')?.classList.contains('on') !== false;
    const lanePair = `${Math.min(oddLane,evenLane)}-${Math.max(oddLane,evenLane)}`;
    const laneStart = startOdd ? Math.min(oddLane,evenLane) : Math.max(oddLane,evenLane);

    const newId = db.ids.series++;
    G.leagueID = leagueID;
    db.series.push({ SeriesID:newId, LeagueID:leagueID, CenterID:centerID,
      DateBowled:date, LanePair:lanePair, LaneStart:laneStart, BallID:ballID, Notes:notes });
    G.seriesID = newId; G.laneStart = laneStart; G.lanePair = lanePair;
    G.oddLane = Math.min(oddLane,evenLane); G.evenLane = Math.max(oddLane,evenLane);
    saveDB(); closeModal();
    createAndStartGame();
  }
}

function openSeriesStatsModal(seriesID) {
  const s = db.series.find(x=>x.SeriesID===seriesID);
  const games = db.games.filter(g=>g.SeriesID===seriesID).sort((a,b)=>a.GameNumber-b.GameNumber);
  const scores = games.map(g=>g.FinalScore).filter(x=>x!=null);
  const total = scores.reduce((a,b)=>a+b,0);
  const avg = scores.length ? Math.round(total/scores.length) : 0;

  // Aggregate frame stats across all completed games
  const allFrames = games.flatMap(g => {
    const fr = db.frames.filter(f=>f.GameID===g.GameID && f.FrameNumber<=9);
    return fr;
  });
  const strikes = allFrames.filter(f=>f.Strike).length;
  const spares = allFrames.filter(f=>f.Spare).length;
  const opens = allFrames.filter(f=>!f.Strike&&!f.Spare).length;
  const spOpp = allFrames.filter(f=>!f.Strike).length;
  const spRate = spOpp > 0 ? Math.round(spares/spOpp*100) : 0;

  const d = s?.DateBowled ? new Date(s.DateBowled).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
  const scoreRows = scores.map((sc,i)=>`<div class="stat-row"><span>Game ${i+1}</span><span class="sval t">${sc}</span></div>`).join('');

  openModal(`
    <div class="modal-title">Series Stats</div>
    <div style="font-size:12px;color:var(--t3);margin-bottom:12px">${d}</div>
    ${scoreRows}
    <div class="stat-row" style="border-top:1px solid var(--border1);margin-top:6px;padding-top:10px">
      <span style="font-weight:800">Total</span><span class="sval" style="color:var(--gold);font-size:18px">${total||'—'}</span>
    </div>
    <div class="stat-row"><span>Average</span><span class="sval t">${avg||'—'}</span></div>
    <div class="stat-row"><span>Strikes (F1–9)</span><span class="sval g">${strikes}</span></div>
    <div class="stat-row"><span>Spares (F1–9)</span><span class="sval t">${spares}</span></div>
    <div class="stat-row"><span>Opens (F1–9)</span><span class="sval s">${opens}</span></div>
    <div class="stat-row"><span>Spare Rate</span><span class="sval">${spRate}%</span></div>
    <button class="btn btn-secondary" onclick="closeModal()" style="margin-top:16px">Close</button>
  `);
}

function openBallModal() {
  const rows = db.balls.map(b=>`
    <div class="list-row" onclick="selectBall(${b.BallID})">
      <div class="list-row-body">
        <div class="list-row-name">${b.BallName}</div>
        <div class="list-row-meta">${b.Weight} lb</div>
      </div>
      ${b.BallID===G.ballID?'<span style="color:var(--teal);font-size:20px">✓</span>':''}
    </div>`).join('');
  openModal(`<div class="modal-title">Select Ball</div>${rows}
    <button class="btn btn-ghost btn-sm" style="margin-top:8px;width:auto" onclick="openAddBallModal()">+ Add Ball</button>`);
}

function selectBall(id) {
  G.ballID = id;
  const ball = db.balls.find(b=>b.BallID===id);
  document.getElementById('ball-name-display').textContent = ball?.BallName||'';
  closeModal();
}

function openAddBallModal() {
  openModal(`
    <div class="modal-title">Add Ball</div>
    <div class="fgroup"><label class="flabel">Ball Name</label>
      <input class="finput" id="ab-name" placeholder="e.g. Roto Grip Idol Pearl" type="text" autocomplete="off"></div>
    <div class="fgroup"><label class="flabel">Weight (lbs)</label>
      <input class="finput" id="ab-wt" type="number" value="15" min="6" max="16"></div>
    <button class="btn btn-primary" onclick="saveNewBall()">Add Ball</button>
    <button class="btn btn-secondary" onclick="openBallModal()">Back</button>
  `);
}

function saveNewBall() {
  const name = document.getElementById('ab-name').value.trim();
  if (!name) { toast('Enter a ball name'); return; }
  const wt = parseInt(document.getElementById('ab-wt').value)||15;
  const id = db.ids.ball++;
  db.balls.push({ BallID:id, BallName:name, Weight:wt, MFG:'', Active:true });
  saveDB(); closeModal(); toast('Ball added!');
}

function openExportModal() {
  const json = JSON.stringify(db, null, 2);
  const kb = (new Blob([json]).size/1024).toFixed(1);
  const attempts = db.attempts.filter(a=>a.Pinfall!==null).length;
  openModal(`
    <div class="modal-title">Export Data</div>
    <p style="font-size:13px;color:var(--t2);line-height:1.5;margin-bottom:16px">
      Export mirrors your Access schema:<br>
      <span style="color:var(--teal)">tblSeries → tblGames → tblFrames → tblAttempts</span><br>
      All Pin, PinStart, PinDelta, and BSK_Progressive fields included.
    </p>
    <div class="card" style="font-size:12px;color:var(--t3);margin-bottom:16px">
      📊 ${db.series.length} series · ${db.games.length} games · ${attempts} attempts · ~${kb} KB
    </div>
    <button class="btn btn-primary" onclick="downloadExport()">⬇ Download JSON</button>
    <button class="btn btn-secondary" onclick="copyExport()">📋 Copy to Clipboard</button>
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
  `);
}

function downloadExport() {
  const blob = new Blob([JSON.stringify(db, null, 2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=`BowlingDB_${new Date().toISOString().split('T')[0]}.json`;
  a.click(); URL.revokeObjectURL(url);
  toast('Exported!');
}

function copyExport() {
  navigator.clipboard?.writeText(JSON.stringify(db,null,2))
    .then(()=>toast('Copied!')).catch(()=>toast('Use Download instead'));
}

function openSettingsModal() {
  const balls = db.balls.map(b=>`
    <div class="stat-row">
      <span>${b.BallName}</span>
      <div style="display:flex;align-items:center;gap:10px">
        <span class="sval" style="font-size:11px;color:var(--t3)">${b.Weight}lb · ID:${b.BallID}</span>
        <span style="cursor:pointer;color:var(--t3);font-size:18px" onclick="deleteBall(${b.BallID})" title="Remove">×</span>
      </div>
    </div>`).join('');

  const centers = db.centers.map(c=>`
    <div class="stat-row">
      <span>${c.CenterName}</span>
      <span class="sval" style="font-size:11px;color:var(--t3)">ID:${c.CenterID}</span>
    </div>`).join('');

  openModal(`
    <div class="modal-title">Settings</div>

    <!-- ── ID Seeds ──────────────────────────────────────── -->
    <div class="settings-section">
      <div class="settings-section-hdr">Production ID Seeds
        <span class="settings-section-hint">Match your Access DB auto-number counters</span>
      </div>
      <div class="id-seed-grid">
        <div class="id-seed-row">
          <label class="id-seed-lbl">Series</label>
          <input class="id-seed-input" id="seed-series" type="number" value="${db.ids.series}" min="1">
        </div>
        <div class="id-seed-row">
          <label class="id-seed-lbl">Game</label>
          <input class="id-seed-input" id="seed-game" type="number" value="${db.ids.game}" min="1">
        </div>
        <div class="id-seed-row">
          <label class="id-seed-lbl">Frame</label>
          <input class="id-seed-input" id="seed-frame" type="number" value="${db.ids.frame}" min="1">
        </div>
        <div class="id-seed-row">
          <label class="id-seed-lbl">Attempt</label>
          <input class="id-seed-input" id="seed-attempt" type="number" value="${db.ids.attempt}" min="1">
        </div>
        <div class="id-seed-row">
          <label class="id-seed-lbl">League</label>
          <input class="id-seed-input" id="seed-league" type="number" value="${db.ids.league}" min="1">
        </div>
        <div class="id-seed-row">
          <label class="id-seed-lbl">Center</label>
          <input class="id-seed-input" id="seed-center" type="number" value="${db.ids.center}" min="1">
        </div>
        <div class="id-seed-row">
          <label class="id-seed-lbl">Ball</label>
          <input class="id-seed-input" id="seed-ball" type="number" value="${db.ids.ball}" min="1">
        </div>
        <div class="id-seed-row">
          <label class="id-seed-lbl">Pattern</label>
          <input class="id-seed-input" id="seed-pattern" type="number" value="${db.ids.pattern||1}" min="1">
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-top:6px" onclick="saveIDSeeds()">Apply ID Seeds</button>
    </div>

    <!-- ── Balls ─────────────────────────────────────────── -->
    <div class="settings-section">
      <div class="settings-section-hdr">Your Balls</div>
      ${balls}
      <button class="btn btn-ghost btn-sm" style="margin-top:4px" onclick="openAddBallModal()">+ Add Ball</button>
    </div>

    <!-- ── Patterns ───────────────────────────────────────── -->
    <div class="settings-section">
      <div class="settings-section-hdr">Oil Patterns</div>
      ${db.patterns.length ? db.patterns.map(p=>`
        <div class="stat-row">
          <span>${p.PatternName}</span>
          <div style="display:flex;align-items:center;gap:10px">
            <span class="sval" style="font-size:11px;color:var(--t3)">${p.Length?p.Length+'ft ':''}${p.Oil||''} · ID:${p.PatternID}</span>
            <span style="cursor:pointer;color:var(--t3);font-size:18px" onclick="deletePattern(${p.PatternID})" title="Remove">×</span>
          </div>
        </div>`).join('') : '<div style="font-size:12px;color:var(--t3);padding:4px 0">No patterns added yet</div>'}
      <button class="btn btn-ghost btn-sm" style="margin-top:4px" onclick="openAddPatternModal()">+ Add Pattern</button>
    </div>

    <!-- ── Centers ───────────────────────────────────────── -->
    <div class="settings-section">
      <div class="settings-section-hdr">Bowling Centers</div>
      ${centers}
      <button class="btn btn-ghost btn-sm" style="margin-top:4px" onclick="openAddCenterModal()">+ Add Center</button>
    </div>

    <!-- ── BSK Pin Images ─────────────────────────────────── -->
    <div class="settings-section">
      <div class="settings-section-hdr">Custom Pin Images
        <span class="settings-section-hint">Override B/S/K dot colors with custom images</span>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px">
        ${['B','S','K'].map(state=>{
          const label = state==='B'?'Base (up)':state==='S'?'Standing':'Knocked';
          const has = db.customPins[state];
          return `<div style="text-align:center">
            <div style="font-size:11px;color:var(--t3);margin-bottom:4px">${label}</div>
            <div style="width:36px;height:36px;border-radius:50%;margin:0 auto 6px;border:2px dashed var(--border1);overflow:hidden;background:var(--bg1);display:flex;align-items:center;justify-content:center">
              ${has?`<img src="${has}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:'<span style="color:var(--t3);font-size:10px">none</span>'}
            </div>
            <label style="cursor:pointer">
              <span class="btn btn-ghost btn-sm" style="font-size:11px;pointer-events:none">Choose</span>
              <input type="file" accept="image/*" style="display:none" onchange="loadPinImage('${state}',this)">
            </label>
            ${has?`<div style="margin-top:4px"><span class="btn btn-ghost btn-sm" style="font-size:11px;color:var(--t3)" onclick="clearPinImage('${state}')">Clear</span></div>`:''}
          </div>`;
        }).join('')}
      </div>
    </div>

    <div class="divider"></div>
    <button class="btn btn-danger" onclick="confirmReset()">Reset All Data</button>
    <button class="btn btn-secondary" onclick="closeModal()" style="margin-top:8px">Close</button>
  `);
}

function saveIDSeeds() {
  const fields = ['series','game','frame','attempt','league','center','ball','pattern'];
  let changed = false;
  fields.forEach(f => {
    const el = document.getElementById(`seed-${f}`);
    if (!el) return;
    const v = parseInt(el.value);
    if (!isNaN(v) && v > 0) { db.ids[f] = v; changed = true; }
  });
  if (changed) { saveDB(); toast('ID seeds saved ✓'); }
  else toast('No valid values entered');
}

function deleteBall(id) {
  const inUse = db.attempts.some(a=>a.BallID===id) || db.series.some(s=>s.BallID===id);
  if (inUse) { toast('Ball is in use — cannot delete'); return; }
  if (!confirm('Remove this ball?')) return;
  db.balls = db.balls.filter(b=>b.BallID!==id);
  saveDB(); openSettingsModal(); toast('Ball removed');
}

function openAddCenterModal() {
  openModal(`
    <div class="modal-title">Add Center</div>
    <div class="fgroup"><label class="flabel">Center Name</label>
      <input class="finput" id="ac-name" placeholder="e.g. Bowlero Tempe" type="text" autocomplete="off"></div>
    <button class="btn btn-primary" onclick="saveNewCenter()">Add Center</button>
    <button class="btn btn-secondary" onclick="openSettingsModal()">Back</button>
  `);
}

function saveNewCenter() {
  const name = document.getElementById('ac-name').value.trim();
  if (!name) { toast('Enter a center name'); return; }
  const id = db.ids.center++;
  db.centers.push({ CenterID:id, CenterName:name, Address:'', City:'', State:'', Zip:'', Lanes:0, LaneSurface:'', Website:'', ProShop:false });
  saveDB(); closeModal(); toast('Center added!');
}

/* ─── Patterns ─────────────────────────────────────────────── */
function openAddPatternModal() {
  openModal(`
    <div class="modal-title">Add Oil Pattern</div>
    <div class="fgroup"><label class="flabel">Pattern Name</label>
      <input class="finput" id="ap-name" placeholder="e.g. Cheetah, Chameleon" type="text" autocomplete="off"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="fgroup"><label class="flabel">Length (ft)</label>
        <input class="finput" id="ap-length" type="number" min="0" max="60" placeholder="e.g. 36"></div>
      <div class="fgroup"><label class="flabel">Oil Volume / Notes</label>
        <input class="finput" id="ap-oil" type="text" placeholder="e.g. Medium, 22mL"></div>
    </div>
    <button class="btn btn-primary" onclick="saveNewPattern()">Add Pattern</button>
    <button class="btn btn-secondary" onclick="openSettingsModal()">Back</button>
  `);
  setTimeout(()=>document.getElementById('ap-name')?.focus(), 350);
}

function saveNewPattern() {
  const name = document.getElementById('ap-name').value.trim();
  if (!name) { toast('Enter a pattern name'); return; }
  const length = parseFloat(document.getElementById('ap-length').value)||null;
  const oil = document.getElementById('ap-oil').value.trim();
  const id = db.ids.pattern++;
  db.patterns.push({ PatternID:id, PatternName:name, Length:length, Oil:oil });
  saveDB(); openSettingsModal(); toast('Pattern added!');
}

function deletePattern(id) {
  const inUse = db.games.some(g=>g.PatternID===id);
  if (inUse) { toast('Pattern is in use — cannot delete'); return; }
  if (!confirm('Remove this pattern?')) return;
  db.patterns = db.patterns.filter(p=>p.PatternID!==id);
  saveDB(); openSettingsModal(); toast('Pattern removed');
}

/* ─── Custom Pin Images ────────────────────────────────────── */
function loadPinImage(state, input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 512*1024) { toast('Image too large (max 512KB)'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    db.customPins[state] = e.target.result;
    saveDB();
    applyCustomPinImages();
    openSettingsModal();
    toast(`Pin image set for ${state==='B'?'Base':state==='S'?'Standing':'Knocked'}`);
  };
  reader.readAsDataURL(file);
}

function clearPinImage(state) {
  db.customPins[state] = null;
  saveDB();
  applyCustomPinImages();
  openSettingsModal();
  toast('Pin image cleared');
}

function applyCustomPinImages() {
  let el = document.getElementById('custom-pin-style');
  if (!el) { el = document.createElement('style'); el.id = 'custom-pin-style'; document.head.appendChild(el); }
  const rules = [];
  const cp = db.customPins || {};
  if (cp.B) rules.push(`.dot.B { background-image:url("${cp.B}"); background-size:cover; background-color:transparent; }`);
  if (cp.S) rules.push(`.dot.S { background-image:url("${cp.S}"); background-size:cover; background-color:transparent; }`);
  if (cp.K) rules.push(`.dot.K { background-image:url("${cp.K}"); background-size:cover; background-color:transparent; }`);
  el.textContent = rules.join('\n');
}


function confirmReset() {
  if (confirm('Delete ALL bowling data? This cannot be undone.')) {
    localStorage.removeItem(STORE_KEY);
    db = buildFreshDB(); saveDB();
    closeModal(); navTo('s-home');
    toast('Data reset');
  }
}

/* =============================================================
   ATTEMPT NOTES — icon in scoring screen
   ============================================================= */
function openAttemptNotesModal() {
  // Get current attempt record
  const frame = getFrame(G.frame);
  if (!frame) return;
  const att = frameAttempts(frame.FrameID).find(a=>a.Attempt===G.attempt);
  if (!att) return;

  const existingNote = att.AttemptNotes || '';
  openModal(`
    <div class="modal-title">Attempt Notes</div>
    <div class="notes-context">Frame ${G.frame} · Attempt ${G.attempt}${att.Pinfall!==null ? ` · ${att.Pinfall} pins` : ''}</div>
    <textarea class="notes-modal-textarea" id="notes-textarea" placeholder="Type your shot note here…" maxlength="500">${existingNote}</textarea>
    <button class="btn btn-primary" style="margin-top:12px" onclick="saveAttemptNote()">Save Note</button>
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
  `);
  setTimeout(()=>document.getElementById('notes-textarea')?.focus(), 350);
}

function saveAttemptNote() {
  const frame = getFrame(G.frame);
  if (!frame) return;
  const att = frameAttempts(frame.FrameID).find(a=>a.Attempt===G.attempt);
  if (!att) return;
  const note = document.getElementById('notes-textarea')?.value?.trim() || '';
  att.AttemptNotes = note || null;
  saveDB();
  updateNotesIconState();
  closeModal();
  toast(note ? 'Note saved 📝' : 'Note cleared');
}

function updateNotesIconState() {
  // Check if current attempt has a note
  const frame = getFrame(G.frame);
  const att = frame ? frameAttempts(frame.FrameID).find(a=>a.Attempt===G.attempt) : null;
  const hasNote = !!(att?.AttemptNotes);
  const btn = document.getElementById('notes-icon-btn');
  if (btn) btn.classList.toggle('has-note', hasNote);
}

/* =============================================================
   NOTAP TOGGLE — game-level, scorecard display toggle
   ============================================================= */
function toggleNoTap() {
  const game = db.games.find(g=>g.GameID===G.gameID);
  if (!game) return;
  game.NoTap = !game.NoTap;
  G.noTap = game.NoTap;
  saveDB();
  // Show/hide the display toggle on scorecard
  updateNoTapUI();
  toast(game.NoTap ? 'NoTap ON 🎳' : 'NoTap OFF');
}

function setScoreDisplay(mode) {
  G.scoreDisplay = mode;
  document.getElementById('sc-dt-std').classList.toggle('on', mode==='standard');
  document.getElementById('sc-dt-nt').classList.toggle('on', mode==='notap');
  renderScorecard('sc-grid', false);
}

function updateNoTapUI() {
  const game = db.games.find(g=>g.GameID===G.gameID);
  const toggle = document.getElementById('notap-display-toggle');
  const switchEl = document.getElementById('notap-toggle');
  const label = document.getElementById('notap-label');
  if (toggle) toggle.style.display = game?.NoTap ? 'block' : 'none';
  if (switchEl) switchEl.classList.toggle('on', !!(game?.NoTap));
  if (label) label.style.color = game?.NoTap ? 'var(--gold)' : 'var(--t3)';
  if (!game?.NoTap) {
    G.scoreDisplay = 'standard';
    document.getElementById('sc-dt-std')?.classList.add('on');
    document.getElementById('sc-dt-nt')?.classList.remove('on');
  }
}

/* =============================================================
   NOTAP SCORE CALCULATION
   In NoTap mode, a 9-pin count on Attempt 1 is treated as a strike
   for SCORING purposes only. Pin entry is unchanged.
   ============================================================= */
function calculateNoTapScores(frames) {
  // Build parallel noTap running total
  let running = 0;
  frames.forEach((fr, i) => {
    const atts = frameAttempts(fr.FrameID);
    const a1 = atts.find(a=>a.Attempt===1);
    const a2 = atts.find(a=>a.Attempt===2);
    const a3 = atts.find(a=>a.Attempt===3);
    const p1 = a1?.Pinfall, p2 = a2?.Pinfall, p3 = a3?.Pinfall;

    // In NoTap: treat 9 on att1 as strike for scoring
    const ntStrike = fr.FrameNumber<=9 && (p1===10 || p1===9);
    const ntSpare = fr.FrameNumber<=9 && !ntStrike && p2!=null && (p1+p2)>=10;

    if (p1===null || p1===undefined) { fr.NoTapFrameScore=null; fr.NoTapRunningTotal=null; return; }

    if (fr.FrameNumber <= 9) {
      if (ntStrike) {
        const bonus = nextBalls(frames, i, 2);
        if (bonus===null) { fr.NoTapFrameScore=null; fr.NoTapRunningTotal=null; return; }
        fr.NoTapFrameScore = 10 + bonus;
      } else if (ntSpare) {
        const bonus = nextBalls(frames, i, 1);
        if (bonus===null) { fr.NoTapFrameScore=null; fr.NoTapRunningTotal=null; return; }
        fr.NoTapFrameScore = 10 + bonus;
      } else {
        if (p2===null) { fr.NoTapFrameScore=null; fr.NoTapRunningTotal=null; return; }
        fr.NoTapFrameScore = p1 + p2;
      }
    } else {
      // Frame 10: in NoTap, a 9 on att1 grants a bonus ball
      let sum = p1;
      const f10NtStrike1 = (p1===10||p1===9);
      const f10NtStrike2 = (p2===10||p2===9);
      // Frame 10 in NoTap: just sum all available (same as standard, the 9-pin grants ball)
      if (p2!==null) sum += p2;
      if (p3!==null) sum += p3;
      fr.NoTapFrameScore = sum;
    }
    running += (fr.NoTapFrameScore||0);
    fr.NoTapRunningTotal = running;
  });
}

/* =============================================================
   ATTEMPT NOTES — click-in/click-out modal
   ============================================================= */
function openAttemptNotes() {
  const frame = getFrame(G.frame);
  if (!frame) return;
  const att = frameAttempts(frame.FrameID).find(a=>a.Attempt===G.attempt);
  // If current attempt has no pinfall yet, use the last recorded one in this frame
  let targetAtt = att;
  if (!att || att.Pinfall === null) {
    const recorded = frameAttempts(frame.FrameID).filter(a=>a.Pinfall!==null);
    targetAtt = recorded.sort((a,b)=>b.Attempt-a.Attempt)[0] || att;
  }
  if (!targetAtt) { toast('No attempt to annotate yet'); return; }

  const existing = targetAtt.AttemptNotes || '';
  const label = targetAtt.Pinfall !== null
    ? `Frame ${targetAtt.FrameNumber}, Attempt ${targetAtt.Attempt}`
    : `Frame ${G.frame}, Attempt ${G.attempt} (pending)`;

  openModal(`
    <div class="modal-title">✎ Attempt Note</div>
    <div style="font-size:11px;color:var(--t3);margin-bottom:14px;letter-spacing:0.5px">${label}</div>
    <div class="fgroup">
      <label class="flabel">Note</label>
      <textarea class="notes-textarea" id="att-note-input" placeholder="e.g. Light 10-pin hit, missed left on spare...">${existing}</textarea>
    </div>
    <button class="btn btn-primary" onclick="saveAttemptNote(${targetAtt.AttemptID})">Save Note</button>
    <button class="btn btn-ghost" onclick="clearAttemptNote(${targetAtt.AttemptID})">Clear Note</button>
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
  `);
  setTimeout(()=>document.getElementById('att-note-input')?.focus(), 350);
}

function saveAttemptNote(attID) {
  const note = (document.getElementById('att-note-input')?.value || '').trim();
  const att = db.attempts.find(a=>a.AttemptID===attID);
  if (att) { att.AttemptNotes = note; saveDB(); }
  closeModal();
  updateNotesIcon();
  toast(note ? 'Note saved ✓' : 'Note cleared');
}

function clearAttemptNote(attID) {
  const att = db.attempts.find(a=>a.AttemptID===attID);
  if (att) { att.AttemptNotes = ''; saveDB(); }
  closeModal();
  updateNotesIcon();
  toast('Note cleared');
}

function updateNotesIcon() {
  const icon = document.getElementById('notes-icon-btn');
  if (!icon) return;
  const frame = getFrame(G.frame);
  if (!frame) return;
  const atts = frameAttempts(frame.FrameID);
  const hasNote = atts.some(a=>a.AttemptNotes && a.AttemptNotes.trim().length > 0);
  icon.classList.toggle('has-note', hasNote);
  icon.title = hasNote ? 'Note added (tap to edit)' : 'Add note to this attempt';
}

/* =============================================================
   NOTAP VIEW TOGGLE
   ============================================================= */
function setNotapView(view) {
  G.notapView = view;
  const stdBtn = document.getElementById('sc-dt-std');
  const tapBtn = document.getElementById('sc-dt-nt');
  if (stdBtn) { stdBtn.classList.toggle('on', view==='standard'); }
  if (tapBtn) { tapBtn.classList.toggle('on', view==='notap'); }
  renderScorecard('sc-grid', false);
}

/* =============================================================
   NOTAP SCORE CALCULATION — 9-pin first ball = strike credit
   ============================================================= */
function calculateNotapScores() {
  const frames = gameFrames().sort((a,b)=>a.FrameNumber-b.FrameNumber);
  let running = 0;

  for (let i=0; i<frames.length; i++) {
    const fr = frames[i];
    const atts = frameAttempts(fr.FrameID);
    const a1 = atts.find(a=>a.Attempt===1);
    const a2 = atts.find(a=>a.Attempt===2);
    const a3 = atts.find(a=>a.Attempt===3);
    const p1raw = a1?.Pinfall;
    const p2 = a2?.Pinfall;
    const p3 = a3?.Pinfall;

    if (p1raw===null || p1raw===undefined) {
      fr.NTFrameScore=null; fr.NTRunningTotal=null; continue;
    }
    // NoTap: 9 on first ball of fresh rack = treat as 10 (strike)
    const p1nt = p1raw >= 9 ? 10 : p1raw;
    const ntStrike = p1nt === 10;

    if (fr.FrameNumber <= 9) {
      if (ntStrike) {
        // Bonus = next 2 balls (raw pinfall values)
        const bonus = nextBalls(frames, i, 2);
        if (bonus===null) { fr.NTFrameScore=null; fr.NTRunningTotal=null; continue; }
        fr.NTFrameScore = 10 + bonus;
      } else {
        const ntSpare = p2!==null && (p1raw + p2) >= 10;
        if (ntSpare) {
          const bonus = nextBalls(frames, i, 1);
          if (bonus===null) { fr.NTFrameScore=null; fr.NTRunningTotal=null; continue; }
          fr.NTFrameScore = 10 + bonus;
        } else {
          if (p2===null) { fr.NTFrameScore=null; fr.NTRunningTotal=null; continue; }
          fr.NTFrameScore = p1raw + p2;
        }
      }
    } else {
      // Frame 10: raw sum (NoTap strike credit displayed via attBoxHTML, but score stays raw)
      let sum = p1raw;
      if (p2!==null) sum += p2;
      if (p3!==null) sum += p3;
      // If p1 was NoTap strike (9 pins), add 1 to frame score
      if (p1raw === 9) sum += 1;
      fr.NTFrameScore = sum;
    }

    running += fr.NTFrameScore;
    fr.NTRunningTotal = running;
  }
}

/* =============================================================
   LANE PAIR SETUP HELPERS
   ============================================================= */
function setSeriesStartLane(which) {
  if (!window._seriesModalState) window._seriesModalState = { startOdd:true, noTap:false };
  window._seriesModalState.startOdd = (which === 'odd');
  const oddBtn = document.getElementById('ms-start-odd');
  const evenBtn = document.getElementById('ms-start-even');
  if (oddBtn) oddBtn.className = 'seg-opt' + (which==='odd'?' on':'');
  if (evenBtn) evenBtn.className = 'seg-opt' + (which==='even'?' on':'');
  updateLanePairPreview();
}

function setSeriesNoTap(val) {
  if (!window._seriesModalState) window._seriesModalState = { startOdd:true, noTap:false };
  window._seriesModalState.noTap = val;
  const offBtn = document.getElementById('ms-notap-off');
  const onBtn = document.getElementById('ms-notap-on');
  if (offBtn) offBtn.className = 'seg-opt' + (!val?' on':'');
  if (onBtn) onBtn.className = 'seg-opt' + (val?' on':'');
}

function updateLanePairPreview() {
  const raw = (document.getElementById('ms-lanepair')?.value || '').trim();
  const el = document.getElementById('ms-lane-preview');
  if (!el) return;
  if (!raw || !raw.includes('-')) { el.textContent = 'Enter a lane pair above'; return; }
  const parts = raw.split('-').map(Number);
  if (parts.length !== 2 || isNaN(parts[0]) || isNaN(parts[1])) {
    el.textContent = 'Enter a valid pair (e.g. 15-16)'; return;
  }
  const [a, b] = parts;
  const odd = a % 2 !== 0 ? a : b;
  const even = a % 2 === 0 ? a : b;
  const startOdd = window._seriesModalState?.startOdd !== false;
  const lane1 = startOdd ? odd : even;
  const lane2 = startOdd ? even : odd;
  el.innerHTML = `G1: <strong style="color:var(--teal)">${lane1}</strong> &rarr; G2: <strong style="color:var(--teal)">${lane2}</strong> &rarr; G3: <strong style="color:var(--teal)">${lane1}</strong>`;
}

/* =============================================================
   HAPTIC FEEDBACK (iPhone Taptic Engine via Vibration API)
   ============================================================= */
function haptic(type) {
  if (!navigator.vibrate) return;
  const patterns = { light:10, medium:20, heavy:40, success:[10,50,20], error:[30,50,30,50,30] };
  navigator.vibrate(patterns[type]||10);
}

/* =============================================================
   TOAST
   ============================================================= */
let toastTimer;
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 2500);
}

/* =============================================================
   DB HELPERS
   ============================================================= */
function gameFrames() { return db.frames.filter(f=>f.GameID===G.gameID); }
function getFrame(fn) { return db.frames.find(f=>f.GameID===G.gameID && f.FrameNumber===fn); }
function frameAttempts(fid) { return db.attempts.filter(a=>a.FrameID===fid).sort((a,b)=>a.Attempt-b.Attempt); }

/* =============================================================
   INIT
   ============================================================= */
document.addEventListener('DOMContentLoaded', ()=>{
  G.ballID = db.balls[0]?.BallID || null;
  applyCustomPinImages();
  renderHome();

  // Prevent scroll wheel from changing number input values globally
  document.addEventListener('wheel', e => {
    if (document.activeElement?.type === 'number') {
      document.activeElement.blur();
    }
  }, { passive: true });
});
</script>
</body>
</html>
